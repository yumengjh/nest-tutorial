---
title: ä¸­é—´ä»¶
createTime: 2025/07/11 10:38:46
permalink: /nest/chcwe1xj/
---

## ä¸­é—´ä»¶{#middleware}

ä¸­é—´ä»¶æ˜¯åœ¨è·¯ç”±å¤„ç†ç¨‹åºä¹‹å‰æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸»è¦ç”¨äºæ‹¦æˆªè¯·æ±‚ã€è®°å½•æ—¥å¿—ã€æƒé™æ ¡éªŒã€ä¿®æ”¹è¯·æ±‚å¯¹è±¡ç­‰ï¼Œå¿…é¡»è°ƒç”¨ `next()` ç»§ç»­æ‰§è¡Œé“¾æ¡ã€‚

ä¸­é—´ä»¶å‡½æ•°å¯ä»¥è®¿é—® `request` å’Œ `response` å¯¹è±¡ï¼Œä»¥åŠåº”ç”¨è¯·æ±‚-å“åº”å‘¨æœŸä¸­çš„ `next()` å‡½æ•°ã€‚	

é»˜è®¤æƒ…å†µä¸‹ï¼ŒNest ä¸­é—´ä»¶ç­‰åŒäº Express ä¸­é—´ä»¶ã€‚

```ts
(req, res, next) => { /* é€»è¾‘ */ }
```

å®˜æ–¹ Express æ–‡æ¡£è¯´æ˜ï¼Œä¸­é—´ä»¶å¯ä»¥ï¼šæ‰§è¡Œä»»æ„ä»£ç ï¼Œä¿®æ”¹ req/resï¼Œç»“æŸè¯·æ±‚ï¼Œæˆ–è°ƒç”¨ `next()` ç»§ç»­å¾€ä¸‹èµ°ï¼Œå¦‚æœä½ ä¸è°ƒç”¨ `next()`ï¼Œè¯·æ±‚å°±â€œå¡æ­»â€äº†ï¼Œæµè§ˆå™¨ä¼šä¸€ç›´ç­‰å¾…å“åº”ã€‚

**å‡½æ•°å¼ä¸­é—´ä»¶**

```ts
function logger(req, res, next) {
  console.log('Request...');
  next();
}
```

**ç±»ä¸­é—´ä»¶**ï¼š

```ts
import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';

@Injectable()
export class LoggerMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    console.log(`Incoming Request to: ${req.method} ${req.url}`);
    next(); // æ”¾è¡Œåˆ°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–æ§åˆ¶å™¨
  }
}
```

ä½¿ç”¨ `@Injectable()` å£°æ˜ï¼Œéœ€è¦å®ç° `NestMiddleware` æ¥å£ï¼Œ`use()` æ–¹æ³•ä¸­å®šä¹‰é€»è¾‘ï¼Œæ”¯æŒä¾èµ–æ³¨å…¥ï¼ˆæ¯”å¦‚ä½ å¯ä»¥æ³¨å…¥æ—¥å¿—æœåŠ¡ï¼‰ã€‚

éœ€è¦æ³¨æ„Express å’Œ Fastify çš„å·®å¼‚ï¼Œå¦‚æœåˆ‡æ¢åˆ° Fastifyï¼Œä¸è¦ç›²ç›®ç…§æ¬ Express çš„ä¸­é—´ä»¶

## ä¾èµ–æ³¨å…¥{#dependency-injection}

Nest ä¸­é—´ä»¶**å®Œå…¨æ”¯æŒä¾èµ–æ³¨å…¥**ï¼Œå°±åƒ provider å’Œ controller ä¸€æ ·ï¼Œå®ƒä»¬å¯ä»¥æ³¨å…¥**åŒä¸€æ¨¡å—ä¸­æ³¨å†Œï¼ˆå¯ç”¨ï¼‰çš„ä¾èµ–**ï¼Œå’Œä¹‹å‰ä¸€æ ·ï¼Œè¿™é€šè¿‡ `constructor` å®ç°ã€‚

## åº”ç”¨ä¸­é—´ä»¶{#applying-middleware}

Nest ä¸­é—´ä»¶çš„æ³¨å†Œ**ä¸æ˜¯å†™åœ¨ `@Module()` è£…é¥°å™¨é‡Œ**ï¼Œè€Œæ˜¯é€šè¿‡æ¨¡å—ç±»çš„ `configure()` æ–¹æ³•ï¼Œåœ¨å…¶ä¸­ä½¿ç”¨ `MiddlewareConsumer` æ˜¾å¼æ³¨å†Œã€‚

`@Module()` è£…é¥°å™¨ä¸­**æ²¡æœ‰ä¸­é—´ä»¶çš„ä½ç½®**ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¨¡å—ç±»çš„ `configure()` æ–¹æ³•æ³¨å†Œä¸­é—´ä»¶ã€‚

```ts
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(LoggerMiddleware)
      .forRoutes('cats');
  }
}
```

`apply()`ï¼šä¼ å…¥ä¸­é—´ä»¶ï¼ˆå¯ä»¥å¤šä¸ªï¼‰

`forRoutes()`ï¼šæŒ‡å®šå“ªäº›è·¯ç”±ä½¿ç”¨ä¸­é—´ä»¶ï¼ˆæ”¯æŒå­—ç¬¦ä¸²ã€å¯¹è±¡ã€æ§åˆ¶å™¨ç±»ï¼‰

`NestModule`ï¼šå¿…é¡»å®ç°è¿™ä¸ªæ¥å£æ‰èƒ½ä½¿ç”¨ `configure()` æ–¹æ³•

**æ”¯æŒæ›´ç²¾å‡†åœ°åŒ¹é…è·¯ç”±å’Œæ–¹æ³•**

```ts

import { Module, NestModule, RequestMethod, MiddlewareConsumer } from '@nestjs/common';
import { LoggerMiddleware } from './common/middleware/logger.middleware';
import { CatsModule } from './cats/cats.module';

@Module({
  imports: [CatsModule],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(LoggerMiddleware)
      .forRoutes({ path: 'cats', method: RequestMethod.GET });
  }
}
```

åªä½œç”¨äº `GET /cats` è¯·æ±‚ï¼Œå¯é…åˆ `RequestMethod.POST / PUT / DELETE` ç²¾ç¡®æ§åˆ¶

```ts
forRoutes(
  { path: 'cats', method: RequestMethod.GET },
  { path: 'cats', method: RequestMethod.POST }
);
```

ä½ ä¹Ÿå¯ä»¥ä½œç”¨äºæ•´ä¸ªæ§åˆ¶å™¨ç±»ï¼š

```ts
forRoutes(CatsController)
```

 é…ç½®æ–¹å¼æ”¯æŒ asyncï¼Œ`configure()` æ–¹æ³•å¯ä»¥æ˜¯å¼‚æ­¥çš„ã€‚

```ts
async configure(consumer: MiddlewareConsumer) {
  const config = await this.configService.load();
  consumer.apply(MyMiddleware).forRoutes(...);
}
```

è™½ç„¶ä¸å¸¸è§ï¼Œä½†åœ¨æŸäº›éœ€è¦â€œç­‰å¾…é…ç½®å®Œæˆâ€åå†å†³å®šåŠ è½½å“ªäº›ä¸­é—´ä»¶çš„åœºæ™¯ä¸­æ˜¯æœ‰ç”¨çš„ã€‚

**æ³¨æ„**ï¼šå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Expressï¼ˆé»˜è®¤é€‚é…å™¨ï¼‰ï¼ŒNest ä¼šè‡ªåŠ¨æ³¨å†Œ `body-parser`ã€‚

è¿™æ„å‘³ç€ï¼š

- Nest å¯åŠ¨æ—¶å·²ç»æ³¨å…¥äº† `express.json()` å’Œ `express.urlencoded()`ï¼›
- å¦‚æœä½ æƒ³ç”¨è‡ªå·±çš„ JSON è§£æå™¨æˆ–å‚æ•°å¤„ç†ä¸­é—´ä»¶ï¼Œæ¯”å¦‚ï¼š

```ts
app.use(bodyParser.json({ limit: '10mb' }));
```

ä½ å¿…é¡»**åœ¨åˆ›å»ºåº”ç”¨æ—¶å…³é—­ Nest é»˜è®¤æ³¨å…¥çš„ bodyParser**ï¼š

```ts
const app = await NestFactory.create(AppModule, {
  bodyParser: false,
});
```

**æ¨èä¸­é—´ä»¶æ³¨å†Œç»“æ„**ï¼š

```ts
@Module({
  imports: [CatsModule],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(LoggerMiddleware, OtherMiddleware)
      .exclude(
        { path: 'cats', method: RequestMethod.POST }, // ä¸ä½œç”¨äº POST /cats
      )
      .forRoutes(CatsController); // å¯¹ CatsController æ‰€æœ‰æ–¹æ³•ç”Ÿæ•ˆ
  }
}
```

## è·¯ç”±é€šé…ç¬¦{#route-wildcards}

Nest æ”¯æŒä½¿ç”¨è·¯å¾„é€šé…ç¬¦ï¼ˆå¦‚ `*splat`ï¼‰åŒ¹é…ç‰¹å®šæ¨¡å¼çš„è·¯ç”±ï¼Œéå¸¸é€‚åˆä¸­é—´ä»¶æ‰¹é‡ä½œç”¨äºä¸€ç±»è·¯å¾„ï¼Œæ¯”å¦‚é™æ€èµ„æºã€API å‰ç¼€ã€å¸¦åŠ¨æ€å‚æ•°çš„è·¯ç”±ç­‰ã€‚

```ts
forRoutes({
  path: 'abcd/*splat',
  method: RequestMethod.ALL,
});
```

ä¸Šé¢è¿™ä¸ªé…ç½®ä¼šåŒ¹é…ï¼š

- `/abcd/1`
- `/abcd/abc`
- `/abcd/anything/here`

`splat` åªæ˜¯é€šé…ç¬¦çš„â€œåå­—â€ï¼Œæ²¡æœ‰ä»»ä½•è¯­ä¹‰é™åˆ¶ï¼Œä½ å¯ä»¥å«å®ƒ `*wildcard`ã€`*pathTail`ï¼Œä»»æ„åç§°éƒ½å¯ä»¥ã€‚

**æ³¨æ„**ï¼š`path: 'abcd/*'`ä¸ä¼šåŒ¹é… `/abcd/` æœ¬èº«ï¼Œä¸ä¼šåŒ¹é… `/abcd/`ï¼Œå› ä¸ºæ²¡æœ‰â€œ*â€åé¢çš„éƒ¨åˆ†ã€‚

åŒ¹é…å¸¦æˆ–ä¸å¸¦å°¾éƒ¨çš„è·¯å¾„ï¼šä½¿ç”¨ `{*splat}`

```ts
path: 'abcd/{*splat}'
```

è¿™ä¼šåŒ¹é…ï¼š

- `/abcd/`
- `/abcd/x`
- `/abcd/x/y`

èŠ±æ‹¬å· `{}` çš„æ„æ€æ˜¯ï¼š**æ•´ä¸ªé€šé…ç¬¦æ®µæ˜¯å¯é€‰çš„**ã€‚

**ä¸¾ä¸ªå®æˆ˜åº”ç”¨**ï¼š

```ts
consumer
  .apply(AuthMiddleware)
  .forRoutes({
    path: 'api/{*wildcard}',
    method: RequestMethod.ALL,
  });
```

ä¸Šé¢ä»£ç ä¼šè®©ä¸­é—´ä»¶ä½œç”¨äºæ‰€æœ‰ä»¥ `/api/` å¼€å¤´çš„è·¯ç”±ï¼ŒåŒ…æ‹¬ `/api`, `/api/user`, `/api/user/123/edit`ã€‚

**å»ºè®®**ï¼š

ä¸æ¨èç”¨å¤ªå®½æ³›çš„é€šé…ç¬¦ï¼ˆå¦‚ `*`ï¼‰ï¼Œå¦åˆ™ä¸­é—´ä»¶ä¼šä½œç”¨äºæ‰€æœ‰è¯·æ±‚ï¼Œå¯èƒ½å¸¦æ¥æ€§èƒ½é—®é¢˜ã€‚

`path: '{*splat}'` é€‚åˆç”¨åœ¨å…¨å±€ fallback ä¸­é—´ä»¶ï¼Œæ¯”å¦‚å‰ç«¯ SPA æ”¯æŒï¼ˆæ¯”å¦‚æ‰€æœ‰é API è·¯ç”±è·³è½¬åˆ° `index.html`ï¼‰ã€‚

## ä¸­é—´ä»¶æ¶ˆè´¹è€…{#middleware-consumer}

`MiddlewareConsumer` æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ç®¡ç†å™¨ï¼Œæä¾›é“¾å¼æ–¹æ³•å¦‚ `.apply()`ã€`.forRoutes()`ã€`.exclude()` ç­‰ï¼Œç”¨äºçµæ´»ç²¾ç¡®åœ°æ§åˆ¶ä¸­é—´ä»¶åœ¨å“ªäº›è·¯ç”±ä¸Šç”Ÿæ•ˆã€‚

`forRoutes()` æ¥æ”¶çš„å‚æ•°ç±»å‹å¾ˆå¤šæ ·ï¼š

| ç±»å‹           | ç¤ºä¾‹                                          | å«ä¹‰                    |
| -------------- | --------------------------------------------- | ----------------------- |
| å­—ç¬¦ä¸²         | `'cats'`                                      | åŒ¹é… `/cats` è·¯ç”±       |
| å¤šä¸ªå­—ç¬¦ä¸²     | `'cats', 'dogs'`                              | åŒ¹é…å¤šä¸ªè·¯å¾„            |
| æ§åˆ¶å™¨ç±»       | `CatsController`                              | åŒ¹é…æ­¤æ§åˆ¶å™¨ä¸­æ‰€æœ‰è·¯ç”±  |
| å¤šä¸ªæ§åˆ¶å™¨ç±»   | `CatsController, DogsController`              | å¤šæ§åˆ¶å™¨æ‰¹é‡æ³¨å†Œ        |
| RouteInfo å¯¹è±¡ | `{ path: 'cats', method: RequestMethod.GET }` | ç²¾ç¡®æŒ‡å®šè·¯å¾„ + è¯·æ±‚æ–¹æ³•ï¼ˆæ”¯æŒå¤šä¸ªå¯¹è±¡ï¼‰ |

 **ç¤ºä¾‹ï¼šä½œç”¨äºå•ä¸ªæ§åˆ¶å™¨**

```ts
@Module({
  imports: [CatsModule],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(LoggerMiddleware)
      .forRoutes(CatsController);
  }
}
```

è¿™è¡¨ç¤ºï¼š`LoggerMiddleware` ä¼š**ä½œç”¨äº `CatsController` çš„æ‰€æœ‰æ–¹æ³•å’Œè·¯å¾„**ã€‚

**æç¤ºï¼šapply() æ”¯æŒå¤šä¸ªä¸­é—´ä»¶**

```ts
consumer
  .apply(LoggerMiddleware, AuthMiddleware, CompressionMiddleware)
  .forRoutes(CatsController);
```

ä½ å¯ä»¥ä¸€æ¬¡æ€§æ³¨å†Œå¤šä¸ªä¸­é—´ä»¶ï¼Œè¿™äº›ä¸­é—´ä»¶ä¼šæŒ‰é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚

| ç”¨æ³•                                               | å»ºè®®                                                    |
| -------------------------------------------------- | ------------------------------------------------------- |
| `apply(...).forRoutes('prefix')`                   | åŒ¹é…ç²¾ç¡®çš„ `/prefix` è·¯å¾„                               |
| `apply(...).forRoutes(SomeController)`             | ç”¨äºä½œç”¨äºæ•´ä¸ªæ§åˆ¶å™¨                                    |
| `apply(...).forRoutes({ path: ..., method: ... })` | ç²¾ç»†æ§åˆ¶è¯·æ±‚è·¯å¾„å’Œæ–¹æ³•                                  |
| `apply(...).exclude(...)`                          | é…åˆ `exclude()` æ’é™¤ç‰¹å®šè·¯ç”±ï¼ˆæ¯”å¦‚æŸäº›æ— éœ€è®¤è¯çš„è·¯å¾„ï¼‰ |

`.exclude()` ç¤ºä¾‹ï¼ˆç»å…¸ç™»å½•ç»•è¿‡åœºæ™¯ï¼‰ï¼š

```ts
consumer
  .apply(AuthMiddleware)
  .exclude({ path: 'auth/login', method: RequestMethod.POST })
  .forRoutes('*');
```

è¿™ä¼šè®©ä¸­é—´ä»¶ä½œç”¨äºæ‰€æœ‰è·¯ç”±ï¼Œ**ä½†æ’é™¤æ‰** POST `/auth/login`ã€‚

## æ’é™¤è·¯ç”±{#excluding-routes}

`.exclude()` æ–¹æ³•å¯ä»¥æ’é™¤ç‰¹å®šè·¯ç”±ï¼Œä½¿ä¸­é—´ä»¶ä¸ä½œç”¨äºè¿™äº›è·¯å¾„ï¼Œé€‚ç”¨äº**ç™»å½•ç™½åå•ã€Webhookç»•è¿‡ã€å®‰å…¨è·¯ç”±æ§åˆ¶**ç­‰åœºæ™¯ã€‚

`exclude()` æ–¹æ³•æ¥å—å•ä¸ªå­—ç¬¦ä¸²ã€å¤šä¸ªå­—ç¬¦ä¸²æˆ– `RouteInfo` å¯¹è±¡æ¥æ ‡è¯†è¦æ’é™¤çš„è·¯ç”±ï¼Œ`.exclude()` å’Œ `.forRoutes()` çš„å‚æ•°ç±»å‹ **åŸºæœ¬ä¸€è‡´**

æ¯”å¦‚ä½ æƒ³ä¸­é—´ä»¶ä½œç”¨äºæ•´ä¸ªæ§åˆ¶å™¨ï¼Œä½†æ’é™¤å…¶ä¸­ä¸€ä¸¤ä¸ªæ–¹æ³•ï¼ˆå¦‚ `/cats` çš„ GETã€POSTï¼‰ã€‚

```ts
consumer
  .apply(LoggerMiddleware)
  .exclude(
    { path: 'cats', method: RequestMethod.GET },
    { path: 'cats', method: RequestMethod.POST },
    'cats/{*splat}',
  )
  .forRoutes(CatsController);
```

å°† `LoggerMiddleware` åº”ç”¨äº `CatsController` çš„æ‰€æœ‰è·¯ç”±ï¼Œ**ä½†æ’é™¤ä»¥ä¸‹è·¯ç”±**ï¼š

- `GET /cats`
- `POST /cats`
- æ‰€æœ‰ `/cats/xxx` å­è·¯å¾„

`exclude()` æ˜¯å¯¹ `.forRoutes()` çš„è¡¥å……ï¼Œå®ƒæ˜¯**ä¼˜å…ˆç”Ÿæ•ˆ**çš„ï¼š

å…ˆæ‰§è¡Œ `exclude()` è¿‡æ»¤æ‰ä½ ä¸å¸Œæœ›ä¸­é—´ä»¶ç”Ÿæ•ˆçš„è·¯å¾„ï¼Œå‰©ä¸‹çš„äº¤ç»™ `forRoutes()` åŒ¹é…èŒƒå›´

è·¯å¾„åŒ¹é…ä½¿ç”¨çš„æ˜¯ [`path-to-regexp`](https://github.com/pillarjs/path-to-regexp) åŒ…ï¼ˆExpress ä¹Ÿæ˜¯è¿™ä¸ªï¼‰ï¼Œæ‰€ä»¥ä½ å¯ä»¥æ”¾å¿ƒä½¿ç”¨é€šé…ç¬¦ï¼š`*`ã€`{*splat}`ã€å‚æ•°ç­‰

## åŠŸèƒ½ä¸­é—´ä»¶{#functional-middleware}

å¦‚æœä½ çš„ä¸­é—´ä»¶åªæ˜¯åšäº›ç®€å•çš„è¯·æ±‚æ—¥å¿—ã€è·¯å¾„æ£€æŸ¥ã€IP è¿‡æ»¤ç­‰é€»è¾‘ï¼Œæ²¡æœ‰ä¾èµ–æ³¨å…¥æˆ–çŠ¶æ€ç®¡ç†ï¼Œå°±å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„å‡½æ•°æ¥å®šä¹‰ï¼Œè€Œä¸éœ€è¦å†™ä¸€ä¸ªç±»ã€‚

**ğŸ‘ åŸºäºç±»çš„ä¸­é—´ä»¶ï¼ˆéº»çƒ¦ï¼‰**ï¼š

```ts
import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';

@Injectable()
export class LoggerMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    console.log('Request...');
    next();
  }
}
```

**ğŸ‘ å‡½æ•°å¼ä¸­é—´ä»¶ï¼ˆæ¨èç”¨äºè½»é‡åœºæ™¯ï¼‰**ï¼š

```ts
import { Request, Response, NextFunction } from 'express';

export function logger(req: Request, res: Response, next: NextFunction) {
  console.log('Request...');
  next();
}
```

æ³¨å†Œæ–¹å¼ä¸€æ ·ï¼š

```ts
consumer
  .apply(logger)
  .forRoutes(CatsController);
```

 **å‡½æ•°å¼ä¸­é—´ä»¶çš„é€‚ç”¨åœºæ™¯**ï¼šä¸éœ€è¦ä¾èµ–æ³¨å…¥ï¼Œåªæ‰“å°æ—¥å¿—ã€è®¾ç½® headersã€IP ç™½åå•ç­‰ï¼Œæ²¡æœ‰å†…éƒ¨çŠ¶æ€ï¼Œçº¯é€»è¾‘

**ä¸å»ºè®®ä½¿ç”¨å‡½æ•°å¼çš„æƒ…å†µ**ï¼šä¸­é—´ä»¶éœ€è¦æ³¨å…¥æœåŠ¡ï¼Œéœ€è¦é…ç½®é¡¹ï¼ˆå¦‚è¯»å– configServiceï¼‰ï¼Œ éœ€è¦è®¿é—®æ¨¡å—ä¸Šä¸‹æ–‡ï¼Œä½†åªæœ‰ç±»æ”¯æŒä¾èµ–æ³¨å…¥ & ç”Ÿå‘½å‘¨æœŸ

**ä¼˜é›…ä½¿ç”¨**ï¼š

1. æ”¾åœ¨ `common/middleware/logger.middleware.ts`
2. å¯¹äºä¸­é—´ä»¶åï¼Œå¯ä»¥è§„èŒƒå‘½åä¸º `loggerMiddleware()` æˆ– `logger`ï¼Œå‡½æ•°åå°å†™ã€‚
3. æœ‰çŠ¶æ€çš„ä¸­é—´ä»¶ â†’ ç”¨ç±»ï¼›æ— çŠ¶æ€ â†’ ç”¨å‡½æ•°ã€‚

**å»ºè®®**ï¼šå½“ä½ çš„ä¸­é—´ä»¶ä¸éœ€è¦ä»»ä½•ä¾èµ–æ—¶ï¼Œè¯·è€ƒè™‘ä½¿ç”¨æ›´ç®€å•çš„åŠŸèƒ½ä¸­é—´ä»¶æ›¿ä»£æ–¹æ¡ˆã€‚

## å¤šä¸ªä¸­é—´ä»¶{#multiple-middleware}

ä¸ºäº†ç»‘å®šé¡ºåºæ‰§è¡Œçš„å¤šä¸ªä¸­é—´ä»¶ï¼Œåªéœ€åœ¨ `apply()` æ–¹æ³•ä¸­æä¾›ä¸€ä¸ªé€—å·åˆ†éš”çš„åˆ—è¡¨ï¼š

```ts
consumer.apply(cors(), helmet(), logger).forRoutes(CatsController);
```

å®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼š`cors()` -> `helmet()` -> `logger()`ï¼Œå³ä»å·¦åˆ°å³ä¾æ¬¡æ‰§è¡Œã€‚

**ç±»ä¸­é—´ä»¶å†™ç±»å**ï¼š`LoggerMiddleware`

**å‡½æ•°å¼ä¸­é—´ä»¶å†™å‡½æ•°**ï¼š`logger`ï¼ˆä¸åŠ æ‹¬å·ï¼‰

**ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶ï¼ˆå¦‚ `cors`ï¼‰å†™å‡½æ•°è°ƒç”¨ç»“æœ**ï¼š`cors()`

**Nestå®Œå…¨å…¼å®¹ Express å’Œ Fastify çš„ä¸­é—´ä»¶ç”Ÿæ€**ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨å¤§é‡æˆç†Ÿçš„ä¸­é—´ä»¶åº“

## å¸¸ç”¨ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶åº“{commonly-middleware-libraries}

é€‚ç”¨äº Express é€‚é…å™¨ï¼š

| ä¸­é—´ä»¶                                                       | è¯´æ˜                                                 | å®‰è£…                          |
| ------------------------------------------------------------ | ---------------------------------------------------- | ----------------------------- |
| [`helmet`](https://www.npmjs.com/package/helmet)             | è®¾ç½®å„ç§å®‰å…¨ HTTP å¤´éƒ¨ï¼Œé˜²æ­¢ XSSã€ç‚¹å‡»åŠ«æŒç­‰æ”»å‡»     | `pnpm add helmet`             |
| [`cors`](https://www.npmjs.com/package/cors)                 | å¼€å¯è·¨åŸŸèµ„æºå…±äº«                                     | `pnpm add cors`               |
| [`morgan`](https://www.npmjs.com/package/morgan)             | è¯·æ±‚æ—¥å¿—è®°å½•å™¨ï¼Œæ”¯æŒä¸åŒæ ¼å¼ï¼ˆå¦‚ `combined`ã€`dev`ï¼‰ | `pnpm add morgan`             |
| [`compression`](https://www.npmjs.com/package/compression)   | Gzip å‹ç¼© HTTP å“åº”ä½“ï¼Œæå‡ä¼ è¾“æ•ˆç‡                  | `pnpm add compression`        |
| [`express-rate-limit`](https://www.npmjs.com/package/express-rate-limit) | é™æµä¸­é—´ä»¶ï¼Œé˜²æ­¢æ¥å£åˆ·çˆ†                             | `pnpm add express-rate-limit` |
| [`express-session`](https://www.npmjs.com/package/express-session) | å¤„ç† Session ä¼šè¯ç®¡ç†ï¼ˆé…åˆèº«ä»½è®¤è¯ï¼‰                | `pnpm add express-session`    |
| [`cookie-parser`](https://www.npmjs.com/package/cookie-parser) | è§£æ HTTP è¯·æ±‚ä¸­çš„ Cookie                            | `pnpm add cookie-parser`      |
| [`express-useragent`](https://www.npmjs.com/package/express-useragent) | è§£æè¯·æ±‚å¤´ä¸­çš„ user-agent å­—ç¬¦ä¸²                     | `pnpm add express-useragent`  |

åœ¨ NestJS ä¸­ä½¿ç”¨
```ts
import * as helmet from 'helmet';
import * as cors from 'cors';
import * as morgan from 'morgan';
import * as compression from 'compression';

export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(
        helmet(),
        cors(),
        compression(),
        morgan('dev')
      )
      .forRoutes('*');
  }
}
```

å¦‚æœä½ åˆ‡æ¢åˆ° Fastifyï¼ˆ`@nestjs/platform-fastify`ï¼‰ï¼Œåˆ™è¦ä½¿ç”¨ Fastify å¯¹åº”çš„æ’ä»¶ï¼š

| æ’ä»¶                  | æ›¿ä»£ Express ä¸­é—´ä»¶       |
| --------------------- | ------------------------- |
| `@fastify/cors`       | æ›¿ä»£ `cors`               |
| `@fastify/helmet`     | æ›¿ä»£ `helmet`             |
| `@fastify/compress`   | æ›¿ä»£ `compression`        |
| `@fastify/rate-limit` | æ›¿ä»£ `express-rate-limit` |

é€šè¿‡ `app.register(...)` æ³¨å†Œæ’ä»¶ï¼Œè€Œä¸æ˜¯ `consumer.apply(...)`

**å»ºè®®ç»„åˆï¼ˆå¼€å‘ + ç”Ÿäº§ï¼‰**

| ç”¨é€”       | æ¨èä¸­é—´ä»¶                                   |
| ---------- | -------------------------------------------- |
| å®‰å…¨       | `helmet()`ã€`rate-limit()`                   |
| æ€§èƒ½       | `compression()`ã€Fastify ä¹Ÿæ¨è              |
| ç›‘æ§       | `morgan('dev')` + è‡ªå®šä¹‰ logger              |
| ç”¨æˆ·ç«¯ä¿¡æ¯ | `express-useragent`                          |
| èº«ä»½è®¤è¯   | `cookie-parser()` + `session()`ï¼ˆé…åˆ Authï¼‰ |

## å…¨å±€ä¸­é—´ä»¶{#global-middleware}

å¦‚æœæˆ‘ä»¬æƒ³ä¸€æ¬¡å°†ä¸­é—´ä»¶ç»‘å®šåˆ°æ¯ä¸ªå·²æ³¨å†Œçš„è·¯ç”±ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `INestApplication` å®ä¾‹æä¾›çš„ `use()` æ–¹æ³•

```ts
// main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { logger } from './common/middleware/logger.middleware';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // ç»‘å®šå…¨å±€ä¸­é—´ä»¶ï¼ˆå‡½æ•°å¼ï¼‰
  app.use(logger);

  await app.listen(process.env.PORT ?? 3000);
}
bootstrap();
```

**ç‰¹ç‚¹è¯´æ˜**

| ç‰¹æ€§           | è¯´æ˜                                                 |
| -------------- | :--------------------------------------------------- |
| ä½œç”¨èŒƒå›´       | ç»‘å®šåˆ° **æ‰€æœ‰** è·¯ç”±                                 |
| ä½¿ç”¨æ–¹å¼       | `app.use(...)`                                       |
| æ¨èä¸­é—´ä»¶ç±»å‹ | **å‡½æ•°å¼ä¸­é—´ä»¶**ï¼ˆæ¨èï¼‰ï¼Œä¹Ÿæ”¯æŒç±»ï¼ˆä½†ä¸èƒ½æ³¨å…¥ä¾èµ–ï¼‰ |
| æ³¨å†Œä½ç½®       | å¿…é¡»åœ¨ `main.ts` ä¸­ä½¿ç”¨ `INestApplication` å®ä¾‹      |
| è°ƒç”¨æ—¶æœº       | åœ¨æ‰€æœ‰æ¨¡å—åŠ è½½å®Œåè¿è¡Œ                               |

**æ³¨æ„**ï¼šå…¨å±€ä¸­é—´ä»¶**ä¸èƒ½ä½¿ç”¨ä¾èµ–æ³¨å…¥**

ç±»ä¸­é—´ä»¶å¦‚æœé€šè¿‡ `app.use(...)` æ³¨å†Œï¼Œæ˜¯æ— æ³•æ³¨å…¥ä¾èµ–çš„ï¼å› ä¸ºå®ƒè„±ç¦»äº† Nest çš„æ¨¡å—ä½“ç³»ã€‚

```ts
@Injectable()
export class LoggerMiddleware implements NestMiddleware {
  constructor(private configService: ConfigService) {} // ä¸ä¼šæ³¨å…¥
}
```

æ‰€ä»¥ï¼Œ**ç”¨å‡½æ•°å¼ä¸­é—´ä»¶**ï¼ˆæ¯”å¦‚çº¯ logger å‡½æ•°ï¼‰æ”¾åœ¨å…¨å±€å°±å¥½ï¼Œ **éœ€è¦ä¾èµ–æ³¨å…¥çš„ç±»ä¸­é—´ä»¶**ä¸è¦ç”¨ `app.use()` æ³¨å†Œã€‚

**æ”¯æŒä¾èµ–æ³¨å…¥çš„â€œä¼ªå…¨å±€ä¸­é—´ä»¶â€**

å¦‚æœä½ æƒ³è¦ï¼šä¸­é—´ä»¶ä½œç”¨äºæ•´ä¸ª appï¼ˆå‡ ä¹æ‰€æœ‰è·¯ç”±ï¼‰ï¼Œåˆå¸Œæœ›èƒ½æ³¨å…¥ä¾èµ–ï¼ˆæ¯”å¦‚ `ConfigService`ã€`LoggerService`ï¼‰

```ts
consumer
  .apply(LoggerMiddleware)
  .forRoutes('*'); // åŒ¹é…æ‰€æœ‰è·¯ç”±ï¼ŒåŒ…æ‹¬ Controller ä¸­çš„æ‰€æœ‰ handler
```

è¿™ç§æ–¹å¼ä¸­é—´ä»¶èƒ½åƒæ­£å¸¸æä¾›å™¨ä¸€æ ·æ³¨å…¥ä¾èµ–ï¼Œè¿˜èƒ½é€šè¿‡ `exclude()` ç²¾ç»†æ§åˆ¶èŒƒå›´ã€‚
