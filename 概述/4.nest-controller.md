---
title: æ§åˆ¶å™¨
createTime: 2025/06/13 10:43:49
permalink: /nest/ao5azb7c/
---

**åˆ›å»ºæ–°é¡¹ç›®**

```bash
npm i -g @nestjs/cli
```

```bash
nest new project-name
```

| æ ¸å¿ƒæ–‡ä»¶                 | æ¦‚è¿°                                                         |
| ------------------------ | ------------------------------------------------------------ |
| `app.controller.ts`      | å…·æœ‰å•ä¸€è·¯ç”±çš„åŸºæœ¬æ§åˆ¶å™¨ã€‚                                   |
| `app.controller.spec.ts` | æ§åˆ¶å™¨çš„å•å…ƒæµ‹è¯•ã€‚                                           |
| `app.module.ts`          | åº”ç”¨çš„æ ¹æ¨¡å—ã€‚                                               |
| `app.service.ts`         | å…·æœ‰å•ä¸€æ–¹æ³•çš„åŸºæœ¬æœåŠ¡ã€‚                                     |
| `main.ts`                | ä½¿ç”¨æ ¸å¿ƒå‡½æ•° `NestFactory` åˆ›å»º Nest åº”ç”¨å®ä¾‹çš„åº”ç”¨å…¥å£æ–‡ä»¶ã€‚ |

## æ§åˆ¶å™¨ & è·¯ç”±{#controllers-routing}

> å†…ç½® [validation](https://nest.nodejs.cn/techniques/validation) çš„ CRUD æ§åˆ¶å™¨ï¼š
>
> æŒ‡çš„æ˜¯åŸºæœ¬çš„å¢åˆ æ”¹æŸ¥ï¼ˆCreate, Read, Update, Deleteï¼‰æ“ä½œçš„æ§åˆ¶å™¨æ—¶ï¼Œç³»ç»Ÿå·²ç»å†…ç½®äº†æ•°æ®éªŒè¯æœºåˆ¶ã€‚è¿™æ„å‘³ç€åœ¨å¤„ç†è¯·æ±‚æ—¶ï¼Œæ•°æ®ä¼šè‡ªåŠ¨è¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿ç¬¦åˆé¢„å®šä¹‰çš„è§„åˆ™ï¼Œæ¯”å¦‚å­—æ®µçš„ç±»å‹ã€æ˜¯å¦ä¸ºç©ºã€æ ¼å¼ç­‰ï¼Œä»è€Œæå‡ç³»ç»Ÿçš„å¥å£®æ€§å’Œå®‰å…¨æ€§ã€‚

CLIåˆ›å»ºæ§åˆ¶å™¨ï¼š`nest g controller [name]`

æ§åˆ¶å™¨çš„ç›®çš„æ˜¯å¤„ç†åº”ç”¨çš„ç‰¹å®šè¯·æ±‚ï¼Œé€šå¸¸ï¼Œä¸€ä¸ªæ§åˆ¶å™¨ä¼šå®šä¹‰**å¤šä¸ªè·¯ç”±**ï¼Œæ¯ä¸ªè·¯ç”±éƒ½æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚

 `@Controller()` è£…é¥°å™¨æ˜¯å®šä¹‰åŸºæœ¬æ§åˆ¶å™¨æ‰€å¿…éœ€çš„ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªå¯é€‰çš„è·¯ç”±å‰ç¼€ï¼Œæ¯”å¦‚ "cats"ã€‚

 ä½¿ç”¨ `@Controller()` è£…é¥°å™¨ä¸­çš„è·¯å¾„å‰ç¼€ï¼Œæœ‰åŠ©äºå°†ç›¸å…³çš„è·¯ç”±ç»„ç»‡åœ¨ä¸€èµ·ï¼Œé¿å…ä»£ç é‡å¤ã€‚ 

```ts {4,6}

import { Controller, Get } from '@nestjs/common';

@Controller('cats')
export class CatsController {
  @Get()
  findAll(): string {
    return 'This action returns all cats';
  }
}
```

`@Get()` HTTP è¯·æ±‚æ–¹æ³•è£…é¥°å™¨å‘Šè¯‰ Nest ä¸º HTTP è¯·æ±‚çš„ç‰¹å®šç«¯ç‚¹åˆ›å»ºå¤„ç†ç¨‹åºã€‚

æ­¤ç«¯ç‚¹ç”± HTTP è¯·æ±‚æ–¹æ³•å’Œè·¯ç”±è·¯å¾„å®šä¹‰ï¼Œè·¯ç”±è·¯å¾„åˆ™æ˜¯æ§åˆ¶å™¨å£°æ˜çš„ï¼ˆå¯é€‰ï¼‰å‰ç¼€ä¸æ–¹æ³•è£…é¥°å™¨ä¸­æŒ‡å®šçš„ä»»ä½•è·¯å¾„ç›¸ç»“åˆæ¥ç¡®å®š

ä¸Šé¢ä»£ç ä¸­ï¼Œæ¯ä¸ªè·¯ç”±è®¾ç½®äº†ä¸€ä¸ªå‰ç¼€ (`cats`)ï¼Œå¹¶ä¸”æ²¡æœ‰åœ¨æ–¹æ³•è£…é¥°å™¨ä¸­æ·»åŠ ä»»ä½•ç‰¹å®šè·¯å¾„ï¼Œå› æ­¤ Nest ä¼šå°† `GET /cats` è¯·æ±‚æ˜ å°„åˆ°æ­¤å¤„ç†ç¨‹åºã€‚

**æ€»ç»“**ï¼šè·¯ç”±è·¯å¾„åŒ…æ‹¬å¯é€‰çš„æ§åˆ¶å™¨è·¯å¾„å‰ç¼€å’Œæ–¹æ³•è£…é¥°å™¨ä¸­æŒ‡å®šçš„ä»»ä½•è·¯å¾„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ§åˆ¶å™¨å‰ç¼€æ˜¯ `cats` å¹¶ä¸”æ–¹æ³•è£…é¥°å™¨æ˜¯ `@Get('breed')`ï¼Œåˆ™ç”Ÿæˆçš„è·¯ç”±å°†æ˜¯ `GET /cats/breed`ã€‚

å½“å‘æ­¤ç«¯ç‚¹è§¦å‘ GET è¯·æ±‚æ—¶ï¼ŒNest ä¼šå°†è¯·æ±‚è·¯ç”±åˆ°ç”¨æˆ·å®šä¹‰çš„ `findAll()` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¿”å›200çŠ¶æ€ç ä»¥åŠç›¸å…³è¯·æ±‚ã€‚

å¯ä»¥æœ‰ä¸¤ç§é€‰é¡¹æ“çºµå“åº”ï¼š

- æ ‡å‡†ï¼ˆæ¨èï¼‰ï¼š

  ä½¿ç”¨æ­¤å†…ç½®æ–¹æ³•ï¼Œ**å½“è¯·æ±‚å¤„ç†ç¨‹åºè¿”å› JavaScript å¯¹è±¡æˆ–æ•°ç»„æ—¶ï¼Œå®ƒå°†è‡ªåŠ¨åºåˆ—åŒ–ä¸º JSON**ã€‚ç„¶è€Œï¼Œå½“å®ƒè¿”å› JavaScript åŸºæœ¬ç±»å‹ï¼ˆä¾‹å¦‚ `string`ã€ `number`ã€ `boolean`ï¼‰æ—¶ï¼ŒNest å°†ä»…å‘é€è¯¥å€¼ï¼Œè€Œä¸å°è¯•å¯¹å…¶è¿›è¡Œåºåˆ—åŒ–ã€‚è¿™ä½¿å¾—å“åº”å¤„ç†å˜å¾—ç®€å•ï¼šåªéœ€è¿”å›å€¼ï¼ŒNest å°±ä¼šå¤„ç†å‰©ä¸‹çš„äº‹æƒ…ã€‚

  é»˜è®¤æƒ…å†µä¸‹ï¼Œå“åº”çš„**çŠ¶æ€ä»£ç **å§‹ç»ˆä¸º 200ï¼Œä½†ä½¿ç”¨ 201 çš„ POST è¯·æ±‚é™¤å¤–ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å¤„ç†ç¨‹åºçº§åˆ«æ·»åŠ  `@HttpCode(...)` è£…é¥°å™¨æ¥è½»æ¾æ›´æ”¹æ­¤è¡Œä¸º

- åº“ç‰¹å®š

â€‹	æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç‰¹å®šäºåº“çš„ï¼ˆä¾‹å¦‚ Expressï¼‰ [å“åº”å¯¹è±¡](https://express.nodejs.cn/en/api.html#res)ï¼Œå®ƒå¯ä»¥ä½¿ç”¨æ–¹æ³•å¤„ç†ç¨‹åºç­¾åä¸­çš„ `@Res()` è£…é¥°å™¨æ³¨å…¥ï¼ˆä¾‹å¦‚ `findAll(@Res() response)`ï¼‰ã€‚é€šè¿‡	è¿™ç§æ–¹æ³•ï¼Œä½ å¯ä»¥ä½¿ç”¨è¯¥å¯¹è±¡å…¬å¼€çš„åŸç”Ÿå“åº”å¤„ç†æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ Expressï¼Œä½ å¯ä»¥ä½¿ç”¨ `response.status(200).send()` ç­‰ä»£ç æ„å»ºå“åº”ã€‚

å¦‚æœåŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹æ³•ï¼Œåˆ™è¯¥å•ä¸€è·¯ç”±çš„æ ‡å‡†æ–¹æ³•å°†è‡ªåŠ¨ç¦ç”¨ï¼Œå¹¶ä¸”å°†ä¸å†æŒ‰é¢„æœŸå·¥ä½œã€‚è¦åŒæ—¶ä½¿ç”¨è¿™ä¸¤ç§æ–¹æ³•ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡æ³¨å…¥å“åº”å¯¹è±¡æ¥ä»…è®¾ç½® cookies/headersï¼Œä½†ä»å°†å…¶ä½™éƒ¨åˆ†ç•™ç»™æ¡†æ¶ï¼‰ï¼Œä½ å¿…é¡»åœ¨ `@Res({ passthrough: true })` è£…é¥°å™¨ä¸­å°† `passthrough` é€‰é¡¹è®¾ç½®ä¸º `true`ã€‚

```ts
  @Get()
  getCats(@Res({ passthrough: true }) res: Response) {
    res.status(404);
    res.setHeader('Cache-Control', 'no-store');
    res.setHeader('Content-Type', 'application/json');
    res.setHeader('X-Custom-Header', 'test');
    return {
      name: 'Tom',
      age: 18,
      breed: 'Siamese',
    };
  }
```

## è¯·æ±‚å¯¹è±¡{#request-object}

å¤„ç†ç¨‹åºé€šå¸¸éœ€è¦è®¿é—®å®¢æˆ·ç«¯çš„è¯·æ±‚è¯¦ç»†ä¿¡æ¯ï¼Œé€šè¿‡ `@Req()` è£…é¥°å™¨æ³¨å…¥è¯·æ±‚å¯¹è±¡æ¥è®¿é—®è¯·æ±‚å¯¹è±¡ã€‚

```ts {7}
import { Controller, Get, Req } from '@nestjs/common';
import { Request } from 'express';

@Controller('cats')
export class CatsController {
  @Get()
  findAll(@Req() request: Request): string {
    return 'This action returns all cats';
  }
}
```

> è¦åˆ©ç”¨ `express` ç±»å‹ï¼ˆå¦‚ä¸Šé¢çš„ `request: Request` å‚æ•°ç¤ºä¾‹ï¼‰ï¼Œè¯·ç¡®ä¿å®‰è£… `@types/express` åŒ…ã€‚

è¯·æ±‚å¯¹è±¡åŒ…å«æŸ¥è¯¢å­—ç¬¦ä¸²ã€å‚æ•°ã€HTTP æ ‡å¤´å’Œæ­£æ–‡çš„å±æ€§ï¼Œå®Œæ•´é˜…è¯»æ›´å¤š [Expressè¯·æ±‚](https://express.nodejs.cn/en/api.html#req)

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ ä¸éœ€è¦æ‰‹åŠ¨è®¿é—®è¿™äº›å±æ€§ã€‚ç›¸åï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸“ç”¨è£…é¥°å™¨ï¼Œå¦‚ `@Body()` æˆ– `@Query()`ï¼Œå®ƒä»¬æ˜¯å¼€ç®±å³ç”¨çš„ã€‚

| è£…é¥°å™¨                     | ç›¸åº”å¹³å°ç‰¹å®šå¯¹è±¡                    |
| -------------------------- | ----------------------------------- |
| `@Request(), @Req()`       | `req`                               |
| `@Response(), @Res()`***** | `res`                               |
| `@Next()`                  | `next`                              |
| `@Session()`               | `req.session`                       |
| `@Param(key?: string)`     | `req.params` / `req.params[key]`    |
| `@Body(key?: string)`      | `req.body` / `req.body[key]`        |
| `@Query(key?: string)`     | `req.query` / `req.query[key]`      |
| `@Headers(name?: string)`  | `req.headers` / `req.headers[name]` |
| `@Ip()`                    | `req.ip`                            |
| `@HostParam()`             | `req.hosts`                         |

å½“ä½ åœ¨å¤„ç†å‡½æ•°ä¸­æ³¨å…¥ `@Res()` æˆ– `@Response()` æ—¶ï¼ŒNest å°†è¯¥å¤„ç†ç¨‹åºç½®äº**åº“ç‰¹å®šæ¨¡å¼**ï¼ˆlibrary-specific modeï¼‰ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œ**ä½ éœ€è¦æ‰‹åŠ¨ç®¡ç†å“åº”çš„å‘é€**ï¼Œä¾‹å¦‚ä½¿ç”¨ `res.json(...)` æˆ– `res.send(...)`ã€‚å¦‚æœä½ ä¸è¿™æ ·åšï¼ŒHTTP è¯·æ±‚å°†ä¼šæŒ‚èµ·ã€‚

ä½†å¦‚æœä½ ä½¿ç”¨ `@Res({ passthrough: true })`ï¼Œåˆ™å¯ä»¥**åŒæ—¶ä¿ç•™æ ‡å‡†æ¨¡å¼çš„ç‰¹æ€§**ï¼Œå³å…è®¸ä½ è¿”å›ä¸€ä¸ªå€¼ï¼Œç”± Nest è‡ªåŠ¨å¤„ç†å“åº”ã€‚è¿™ç§æ–¹å¼åœ¨éœ€è¦è®¿é—®åº•å±‚å“åº”å¯¹è±¡çš„åŒæ—¶ï¼Œä»å¯ä½¿ç”¨æ¡†æ¶é»˜è®¤çš„å“åº”æµç¨‹ã€‚

- ä½¿ç”¨ `@Res()` ä¼šåˆ‡æ¢åˆ°åº•å±‚ï¼ˆExpress/Fastifyï¼‰æ¨¡å¼
- **å¿…é¡»æ‰‹åŠ¨å¤„ç†å“åº”ï¼Œå¦åˆ™è¯·æ±‚æŒ‚èµ·**
- ä½¿ç”¨ `{ passthrough: true }` å¯ä»¥â€œä¸¤å…¨å…¶ç¾â€ï¼šè®¿é—®å“åº”å¯¹è±¡ + è‡ªåŠ¨å“åº”

## èµ„æº{#resources}

åœ¨ Nest ä¸­æœ‰æ‰€æœ‰æ ‡å‡†çš„ Http æ–¹æ³•éƒ½æœ‰å¯¹åº”çš„è£…é¥°å™¨ï¼š

`@Get()`ã€`@Post()`ã€`@Put()`ã€`@Delete()`ã€`@Patch()`ã€`@Options()` å’Œ `@Head()`ã€‚æ­¤å¤–ï¼Œ`@All()` å®šä¹‰äº†ä¸€ä¸ªç«¯ç‚¹æ¥å¤„ç†æ‰€æœ‰è¿™äº›ã€‚

## è·¯ç”±é€šé…ç¬¦{#route-wildcards}

NestJS ä¹Ÿæ”¯æŒåŸºäºæ¨¡å¼çš„è·¯ç”±ã€‚ä¾‹å¦‚ï¼Œæ˜Ÿå·ï¼ˆ`*`ï¼‰å¯ç”¨ä½œé€šé…ç¬¦ï¼Œä»¥åŒ¹é…è·¯å¾„æœ«å°¾è·¯ç”±ä¸­çš„ä»»æ„å­—ç¬¦ç»„åˆã€‚

```js
@Get('abcd/*')
findAll() {
  return 'This route uses a wildcard';
}
```

ä»»ä½•ä»¥ `abcd/` å¼€å¤´çš„è·¯ç”±ï¼Œéƒ½å°†æ‰§è¡Œ `findAll()` æ–¹æ³•ï¼Œæ— è®ºåé¢æœ‰å¤šå°‘ä¸ªå­—ç¬¦

é€šé…ç¬¦ä¹Ÿå¯ä»¥ä½äºä¸­é—´ï¼Œä¾‹å¦‚ `@Get('abcd/*/efgh')`ï¼Œè¿™å°†åŒ¹é…æ‰€æœ‰ä»¥ `abcd/` å¼€å¤´å¹¶ä»¥ `/efgh` ç»“å°¾çš„è·¯å¾„ã€‚

## çŠ¶æ€ç {#status-code}

å¯ä»¥é€šè¿‡åœ¨å¤„ç†ç¨‹åºçº§åˆ«ä½¿ç”¨ `@HttpCode(...)` è£…é¥°å™¨è½»æ¾æ›´æ”¹å“åº”çš„çŠ¶æ€ä»£ç ï¼Œå“åº”çš„é»˜è®¤çŠ¶æ€ä»£ç å§‹ç»ˆä¸º 200ï¼Œä½† POST è¯·æ±‚é™¤å¤–ï¼Œå…¶é»˜è®¤ä¸º 201ã€‚

```js
@Post()
@HttpCode(204)
create() {
  return 'This action adds a new cat';
}
```

éœ€è¦ä» `@nestjs/common` åŒ…ä¸­å¯¼å…¥ `HttpCode`ã€‚

é€šå¸¸ï¼Œä½ çš„çŠ¶æ€ä»£ç ä¸æ˜¯é™æ€çš„ï¼Œè€Œæ˜¯å–å†³äºå„ç§å› ç´ ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ç‰¹å®šäºåº“çš„å“åº”ï¼ˆä½¿ç”¨ `@Res()` æ³¨å…¥ï¼‰å¯¹è±¡ï¼ˆæˆ–è€…ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚

::: details ç¤ºä¾‹

```js
import { Controller, Get, Res, Query, HttpException, HttpStatus } from '@nestjs/common';
import { Response } from 'express';

@Controller('users')
export class UserController {
  @Get('check')
  checkUser(@Query('id') id: string, @Res() res: Response) {
    if (!id) {
      // åŠ¨æ€è¿”å› 400 Bad Request
      throw new HttpException('User ID is required', HttpStatus.BAD_REQUEST);
    }

    const userExists = id === '123'; // æ¨¡æ‹ŸæŸ¥æ‰¾

    if (userExists) {
      // åŠ¨æ€è¿”å› 200 OK
      return res.status(200).json({ message: 'User found', id });
    } else {
      // åŠ¨æ€è¿”å› 404 Not Found
      return res.status(404).json({ message: 'User not found' });
    }
  }
}

```

:::

## Req & Res{#req-res}

| å¯¹è±¡              | ä½œç”¨                                                         |
| ----------------- | ------------------------------------------------------------ |
| `req`ï¼ˆRequestï¼‰  | ä»£è¡¨å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚ï¼Œä¾‹å¦‚ headersã€bodyã€queryã€params ç­‰   |
| `res`ï¼ˆResponseï¼‰ | è¡¨ç¤ºæœåŠ¡å™¨å‡†å¤‡å‘é€çš„å“åº”ï¼Œè°ƒç”¨ `res.send()`ã€`res.json()` å°±æ˜¯ç”¨å®ƒæ¥å›å¤ |

**NestJS çš„ä¸¤ç§å“åº”å¤„ç†æ¨¡å¼**

| æ¨¡å¼                            | ç‰¹å¾                                                         | é€‚åˆåœºæ™¯                 |
| ------------------------------- | ------------------------------------------------------------ | ------------------------ |
| **æ ‡å‡†æ¨¡å¼**ï¼ˆé»˜è®¤ï¼‰            | ä½ åªéœ€ `return` æ•°æ®ï¼ŒNest ä¼šè‡ªåŠ¨è°ƒç”¨ `res.json(...)`        | æ¨èä½¿ç”¨                 |
| **åº“ç‰¹å®šæ¨¡å¼**ï¼ˆä½¿ç”¨ `@Res()`ï¼‰ | ä½ éœ€è¦è‡ªå·±è°ƒç”¨ `res.send()`ã€`res.json()` ç­‰ï¼Œå¦åˆ™è¯·æ±‚ä¼šæŒ‚èµ· | éœ€è¦è‡ªå®šä¹‰å“åº”è¡Œä¸ºæ—¶ä½¿ç”¨ |

```js
// æ ‡å‡†æ¨¡å¼ï¼ˆè‡ªåŠ¨å“åº”ï¼‰
@Get('user')
getUser() {
  return { name: 'Alice' }; // Nest è‡ªåŠ¨ res.json({ ... })
}

// ç‰¹å®šæ¨¡å¼ ï¼ˆæ‰‹åŠ¨å“åº”ï¼‰
@Get('user')
getUser(@Res() res: Response) {
  res.json({ name: 'Alice' }); // ä½ å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ï¼Œå¦åˆ™å¯¼è‡´â€œè¯·æ±‚æŒ‚èµ·â€é—®é¢˜
}
```

**æ··åˆæ¨¡å¼**

```js
@Get('user')
getUser(@Res({ passthrough: true }) res: Response) {
  res.setHeader('X-Custom', 'Nest'); // ä½ å¯ä»¥è®¾ç½®å“åº”å¤´
  return { name: 'Alice' }; // Nest ä¼šè‡ªåŠ¨è°ƒç”¨ res.json(...)
}
// æ—¢å¯ä»¥è®¿é—®åº•å±‚å¯¹è±¡ï¼Œåˆä¸å¤±å»è‡ªåŠ¨å“åº”èƒ½åŠ›
```

`@Res({ passthrough: true })`çš„æœ¬è´¨æ˜¯å…è®¸ä½ è®¿é—®åº•å±‚çš„å“åº”å¯¹è±¡ï¼ˆExpress/Fastifyï¼‰ï¼Œä½†ä¸é˜»æ­¢ Nest çš„è‡ªåŠ¨å“åº”å¤„ç†æœºåˆ¶ã€‚

 é»˜è®¤æƒ…å†µä¸‹çš„ `@Res()` æ˜¯â€œå…¨æƒæ¥ç®¡å“åº”â€çš„ï¼Œå½“ä½ ä½¿ç”¨ `@Res()` æ—¶ï¼ŒNestJS ä¼šæŠŠå“åº”æ§åˆ¶æƒ**äº¤ç»™ä½ **ï¼Œä½ å¿…é¡»è‡ªå·±è°ƒç”¨ `res.send()` æˆ– `res.json()`ï¼Œå¦åˆ™ HTTP è¯·æ±‚ä¼šæŒ‚èµ·ï¼ŒNest ä¸ä¼šå†å¸®ä½ åšï¼šè®¾ç½®çŠ¶æ€ç ï¼Œè®¾ç½®å“åº”å¤´ï¼Œå¤„ç†ä½  `return` çš„è¿”å›å€¼ã€‚

åŠ äº† `passthrough: true` åï¼ŒNestJS ä¼šä¿ç•™ä½ è®¿é—®åº•å±‚å“åº”å¯¹è±¡ï¼ˆ`res`ï¼‰çš„èƒ½åŠ›ï¼Œä¾ç„¶ä¼šå¤„ç†ä½ åœ¨å‡½æ•°é‡Œ `return` çš„è¿”å›å€¼ï¼Œå“åº”ä»ç”± Nest è‡ªåŠ¨ `.json()` æˆ– `.send()` å¤„ç†ï¼Œä½ å¯ä»¥æ‰‹åŠ¨è®¾ç½® headersã€cookies ç­‰ã€‚

```js
@Get()
getHello(@Res({ passthrough: true }) res: Response) {
  res.setHeader('X-Powered-By', 'NestJS');
  return { message: 'Hello' }; // Nest ä¼šè‡ªåŠ¨ res.json(...)
}
```

## å“åº”å¤´{#response-headers}

è¦æŒ‡å®šè‡ªå®šä¹‰å“åº”æ ‡å¤´ï¼Œä½ å¯ä»¥ä½¿ç”¨ `@Header()` è£…é¥°å™¨æˆ–åº“ç‰¹å®šçš„å“åº”å¯¹è±¡ï¼ˆå¹¶ç›´æ¥è°ƒç”¨ `res.header()`ï¼‰ã€‚

éœ€è¦ä» `@nestjs/common` åŒ…ä¸­å¯¼å…¥ `Header`ã€‚

| æ–¹æ³•              | æ¥æº          | ä½¿ç”¨æ–¹å¼                                                | æ˜¯å¦é“¾å¼   | ç”Ÿå‘½å‘¨æœŸæ§åˆ¶                          | æ¨èåœºæ™¯                   |
| ----------------- | ------------- | ------------------------------------------------------- | ---------- | ------------------------------------- | -------------------------- |
| `res.setHeader()` | Node.js åŸç”Ÿ  | `res.setHeader('Cache-Control', 'no-store')`            | âŒ å¦       | æœ€åº•å±‚ï¼Œç«‹å³è®¾ç½®                      | âœ… æ¨èï¼Œé€šç”¨æ€§å¼º           |
| `res.header()`    | Express å°è£…  | `res.header('Cache-Control', 'no-store')`               | âœ… æ”¯æŒé“¾å¼ | åŸºäº Express å®ç°                     | âœ” Express é¡¹ç›®ä¸­æ–¹ä¾¿å¥½ç”¨   |
| `@Header()`       | NestJS è£…é¥°å™¨ | `@Header('Cache-Control', 'no-store')` æ”¾åœ¨æ§åˆ¶å™¨æ–¹æ³•ä¸Š | âŒ å¦       | Nest è‡ªåŠ¨è®¾ç½®å“åº”å¤´ï¼ˆåœ¨ `return` å‰ï¼‰ | âœ… æ¨èç”¨äºç®€å•è®¾ç½®å“åº”å¤´æ—¶ |

`res.header`å…è®¸é“¾å¼è°ƒç”¨ï¼š

```js
res.header('A', 'x').header('B', 'y').status(200).send()
```

## é‡å®šå‘{#redirection}

è¦å°†å“åº”é‡å®šå‘åˆ°ç‰¹å®š URLï¼Œä½ å¯ä»¥ä½¿ç”¨ `@Redirect()` è£…é¥°å™¨æˆ–åº“ç‰¹å®šçš„å“åº”å¯¹è±¡ï¼ˆå¹¶ç›´æ¥è°ƒç”¨ `res.redirect()`ï¼‰ã€‚

`@Redirect()` æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œ`url` å’Œ `statusCode`ï¼Œä¸¤è€…éƒ½æ˜¯å¯é€‰çš„ã€‚å¦‚æœçœç•¥ï¼Œ`statusCode` çš„é»˜è®¤å€¼ä¸º `302` (`Found`)ã€‚

```typescript
@Get()
@Redirect('https://nest.nodejs.cn', 301)
```

åŠ¨æ€ç¡®å®š HTTP çŠ¶æ€ä»£ç æˆ–é‡å®šå‘ URLã€‚é€šè¿‡è¿”å›éµå¾ª `HttpRedirectResponse` æ¥å£ï¼ˆæ¥è‡ª `@nestjs/common`ï¼‰çš„å¯¹è±¡æ¥å®Œæˆæ­¤æ“ä½œã€‚

```ts
export interface HttpRedirectResponse {
    url: string;
    statusCode: HttpStatus;
}
```

è¿”å›å€¼å°†è¦†ç›–ä¼ é€’ç»™ `@Redirect()` è£…é¥°å™¨çš„ä»»ä½•å‚æ•°ã€‚ä¾‹å¦‚ï¼š

```ts
@Get('docs')
@Redirect('https://nest.nodejs.cn', 302)
getDocs(@Query('version') version) {
  if (version && version === '5') {
    return { url: 'https://nest.nodejs.cn/v5/' };
  }
}
```

## è·¯ç”±å‚æ•°{#route-parameters}

å½“ä½ éœ€è¦æ¥å—åŠ¨æ€æ•°æ®ä½œä¸ºè¯·æ±‚çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œè¦å®šä¹‰å¸¦æœ‰å‚æ•°çš„è·¯ç”±ï¼Œå¯ä»¥åœ¨è·¯ç”±è·¯å¾„ä¸­æ·»åŠ è·¯ç”±å‚æ•°æ ‡è®°ä»¥ä» URL ä¸­æ•è·åŠ¨æ€å€¼ã€‚ç„¶åå¯ä»¥ä½¿ç”¨ `@Param()` è£…é¥°å™¨è®¿é—®è¿™äº›è·¯ç”±å‚æ•°ï¼Œè¯¥è£…é¥°å™¨åº”æ·»åŠ åˆ°æ–¹æ³•ç­¾åä¸­ã€‚

```ts
@Get(':id')
findOne(@Param() params: any): string {
  console.log(params.id);
  return `This action returns a #${params.id} cat`;
}
```

`@Param()` è£…é¥°å™¨ç”¨äºè£…é¥°æ–¹æ³•å‚æ•°ï¼ˆåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ä¸º `params`ï¼‰ï¼Œä½¿è·¯ç”±å‚æ•°å¯ä½œä¸ºæ–¹æ³•å†…éƒ¨è¯¥è£…é¥°æ–¹æ³•å‚æ•°çš„å±æ€§è®¿é—®ã€‚å¦‚ä»£ç æ‰€ç¤ºï¼Œä½ å¯ä»¥é€šè¿‡å¼•ç”¨ `params.id` æ¥è®¿é—® `id` å‚æ•°ã€‚æˆ–è€…ï¼Œä½ å¯ä»¥å°†ç‰¹å®šçš„å‚æ•°æ ‡è®°ä¼ é€’ç»™è£…é¥°å™¨ï¼Œå¹¶åœ¨æ–¹æ³•ä¸»ä½“ä¸­ç›´æ¥æŒ‰åç§°å¼•ç”¨è·¯ç”±å‚æ•°ã€‚

> ä» `@nestjs/common` åŒ…ä¸­å¯¼å…¥ `Param`ã€‚

```ts

@Get(':id')
findOne(@Param('id') id: string): string {
  return `This action returns a #${id} cat`;
}
```

## å­åŸŸè·¯ç”±{#sub-domain-routing}

`@Controller` è£…é¥°å™¨å¯ä»¥é‡‡ç”¨ `host` é€‰é¡¹æ¥è¦æ±‚ä¼ å…¥è¯·æ±‚çš„ HTTP ä¸»æœºåŒ¹é…æŸä¸ªç‰¹å®šå€¼ã€‚

```ts
@Controller({ host: 'admin.example.com' })
export class AdminController {
  @Get()
  index(): string {
    return 'Admin page';
  }
}
```

ä¸è·¯ç”± `path` ç±»ä¼¼ï¼Œ`host` é€‰é¡¹å¯ä»¥ä½¿ç”¨æ ‡è®°æ¥æ•è·ä¸»æœºåä¸­è¯¥ä½ç½®çš„åŠ¨æ€å€¼ã€‚ä¸‹é¢ `@Controller()` è£…é¥°å™¨ç¤ºä¾‹ä¸­çš„ä¸»æœºå‚æ•°ä»¤ç‰Œæ¼”ç¤ºäº†è¿™ç§ç”¨æ³•ã€‚å¯ä»¥ä½¿ç”¨ `@HostParam()` è£…é¥°å™¨è®¿é—®ä»¥è¿™ç§æ–¹å¼å£°æ˜çš„ä¸»æœºå‚æ•°ï¼Œåº”å°†å…¶æ·»åŠ åˆ°æ–¹æ³•ç­¾åä¸­ã€‚

```ts
@Controller({ host: ':account.example.com' })
export class AccountController {
  @Get()
  getInfo(@HostParam('account') account: string) {
    return account;
  }
}
```

## çŠ¶æ€å…±äº«{#state-sharing}

ç›¸å…³æ–‡ç« ï¼š[å•ä¾‹æ¨¡å¼å’Œè¯·æ±‚çº§ä½œç”¨åŸŸ](./nest-singletons-isolation)

## å¼‚æ­¥æ€§{#asynchronicity}

æ¯ä¸ª `async` å‡½æ•°éƒ½å¿…é¡»è¿”å›ä¸€ä¸ª `Promise`ï¼ŒNest ä¼šè‡ªåŠ¨ç­‰å¾…å®ƒå®Œæˆï¼ˆç­‰å¾…è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡å®Œæˆåå†å“åº”è¯·æ±‚ï¼‰ã€‚

```js
 @Get('a3')
  async getData(): Promise<string> {
    return new Promise(resolve => {
      setTimeout(() => resolve('æœåŠ¡å™¨å»¶è¿Ÿ1ç§’è¿”å›'), 1000);
    });
  }
```

**å¼ºè°ƒ async å‡½æ•°è¿”å› Promise**

å®ƒåŸºäº **å¼‚æ­¥å‡½æ•°çš„è‡ªåŠ¨ç­‰å¾…æœºåˆ¶**ï¼Œä½ å°±å¯ä»¥ï¼š

- ç”¨ `await` å†™å¼‚æ­¥æ•°æ®åº“ã€ç½‘ç»œè¯·æ±‚ç­‰é€»è¾‘ï¼›
- è¿”å›çš„ `Promise` ä¼šè¢« Nest **è‡ªåŠ¨â€œè§£æâ€ï¼ˆawaitï¼‰**ï¼Œå“åº”æ‰ä¼šå‘é€å‡ºå»ï¼›
- ä½ ä¸éœ€è¦è‡ªå·± `.then()` æˆ–å†™å¤æ‚å›è°ƒã€‚

Nest ä¸ä»…æ”¯æŒ `async/await` å†™æ³•ï¼Œè¿˜æ”¯æŒæŠŠè·¯ç”±æ–¹æ³•ç›´æ¥è¿”å›ä¸€ä¸ª **RxJS çš„å¯è§‚å¯Ÿå¯¹è±¡ï¼ˆObservableï¼‰**ã€‚

Nest ä¼šåœ¨å†…éƒ¨è‡ªåŠ¨è®¢é˜…è¿™ä¸ª Observableï¼Œç­‰å®ƒè¿”å›å€¼åå†å‘é€å“åº”ã€‚

**RxJS** æ˜¯ä¸€ä¸ªå¤„ç†å¼‚æ­¥æµçš„åº“ï¼Œæ ¸å¿ƒæ¦‚å¿µæ˜¯ **Observable**ï¼ˆå¯è§‚å¯Ÿå¯¹è±¡ï¼‰ã€‚

å¯ä»¥æŠŠ `Observable` ç±»æ¯”æˆï¼š

- ä¸€ä¸ª **å¯ä»¥æŒç»­å‘å‡ºæ•°æ®çš„â€œå¼‚æ­¥æ•°æ®æµâ€**ï¼ˆä¸åƒ Promise åªèƒ½å‘ä¸€æ¬¡ï¼‰ï¼›
- å®ƒå°±åƒä¸€ä¸ªâ€œäº‹ä»¶å‘å¸ƒè€…â€ï¼Œä½ å¯ä»¥â€œè®¢é˜…â€å®ƒï¼›
- Nest æ”¯æŒå®ƒï¼Œæ˜¯å› ä¸ºå¾ˆå¤šåœºæ™¯éœ€è¦**å“åº”å¼æ•°æ®æµå¤„ç†**ï¼ˆæ¯”å¦‚ WebSocketã€æ¶ˆæ¯é˜Ÿåˆ—ã€æµå¼æ–‡ä»¶ã€è¿ç»­äº‹ä»¶ï¼‰ã€‚

**å¯¹æ¯” Promise å’Œ Observable**

| ç‰¹æ€§         | `Promise`            | `Observable`ï¼ˆRxJSï¼‰                |
| ------------ | -------------------- | ----------------------------------- |
| è§¦å‘æ¬¡æ•°     | åªèƒ½è§¦å‘ä¸€æ¬¡         | å¯ä»¥è§¦å‘å¤šæ¬¡                        |
| æ˜¯å¦å¯å–æ¶ˆ   | ä¸å¯å–æ¶ˆ             | å¯å–æ¶ˆï¼ˆunsubscribeï¼‰               |
| æ”¯æŒç»„åˆæ“ä½œ | è¾ƒå¼±ï¼ˆé  then é“¾å¼ï¼‰ | å¼ºå¤§ï¼ˆmapã€filterã€merge ç­‰æ“ä½œç¬¦ï¼‰ |
| å¸¸ç”¨äº       | å•æ¬¡å¼‚æ­¥è¯·æ±‚ï¼ˆHTTPï¼‰ | å¤šæ¬¡/æµå¼å¼‚æ­¥ä»»åŠ¡ï¼ˆäº‹ä»¶æµã€æ•°æ®æµï¼‰ |

```ts
import { Controller, Get } from '@nestjs/common';
import { Observable, of } from 'rxjs';

@Controller('users')
export class UsersController {
  @Get()
  findAll(): Observable<any[]> {
    return of([
      { id: 1, name: 'å¼ ä¸‰' },
      { id: 2, name: 'æå››' },
    ]);
  }
}
```

`of(...)` æ˜¯ RxJS æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ª Observableï¼Œé‡Œé¢çš„å†…å®¹æ˜¯ä½ ç»™çš„æ•°æ®æ•°ç»„

Nest æ£€æµ‹åˆ°ä½ è¿”å›çš„æ˜¯ Observableï¼Œä¼šè‡ªåŠ¨ `.subscribe()` å®ƒï¼Œç„¶åæŠŠæœ€ç»ˆæ•°æ®ä½œä¸º HTTP å“åº”è¿”å›ï¼›

æ•ˆæœè·Ÿä½ å†™ `async findAll(): Promise<...>` æ˜¯ä¸€æ ·çš„ã€‚

## è¯·æ±‚è´Ÿè½½{#request-payloads}

åœ¨ä½¿ç”¨POST è·¯ç”±å¤„ç†ç¨‹åºæ—¶ï¼Œé€šè¿‡æ·»åŠ  `@Body()` è£…é¥°å™¨æ¥æ¥å—å®¢æˆ·ç«¯å‚æ•°ã€‚

> DTO æ˜¯ä¸€ä¸ªæŒ‡å®šå¦‚ä½•é€šè¿‡ç½‘ç»œå‘é€æ•°æ®çš„å¯¹è±¡ã€‚

å‚æ•°çš„ç±»å‹éœ€è¦ä½¿ç”¨DTOæ•°æ®ä¼ è¾“å¯¹è±¡æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨ TypeScript æ¥å£æˆ–ç®€å•ç±»æ¥å®šä¹‰ DTO æ¨¡å¼ã€‚

å»ºè®®åœ¨æ­¤å¤„ä½¿ç”¨ç±»ã€‚è€Œä¸æ˜¯ `interface`ï¼Œå› ä¸º class åœ¨ç¼–è¯‘åä»ç„¶å­˜åœ¨äºè¿è¡Œæ—¶ï¼Œå¯ä»¥è¢« Nest ç”¨æ¥åšæ ¡éªŒã€è½¬æ¢ã€ä¾èµ–æ³¨å…¥ç­‰é«˜çº§åŠŸèƒ½ã€‚

```ts
import { IsString, IsInt } from 'class-validator';

// DTO
export class CreateCatDto {
  @IsString() name: string;
  @IsInt() age: number;
  @IsString() breed: string;
}
// ä½¿ç”¨DTO
@Post()
async create(@Body() createCatDto: CreateCatDto) {
  return 'This action adds a new cat';
}
```

Nest çš„ `ValidationPipe` å¯ä»¥è¿‡æ»¤æ‰æ–¹æ³•å¤„ç†ç¨‹åºä¸åº”æ¥æ”¶çš„å±æ€§ï¼Œå°†å¯æ¥å—çš„å±æ€§åˆ—å…¥ç™½åå•ï¼Œå¹¶ä¸”ç™½åå•ä¸­æœªåŒ…å«çš„ä»»ä½•å±æ€§éƒ½ä¼šè‡ªåŠ¨ä»ç”Ÿæˆçš„å¯¹è±¡ä¸­åˆ é™¤ã€‚åœ¨ `CreateCatDto` ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„ç™½åå•æ˜¯ `name`ã€`age` å’Œ `breed` å±æ€§ã€‚äº†è§£æ›´å¤š [ValidationPipeï¼ˆéªŒè¯ç®¡é“ï¼‰](https://nest.nodejs.cn/techniques/validation#stripping-properties)ã€‚

**ValidationPipe**ï¼š

```bash
pnpm add class-validator class-transformer	# å¦‚æœæ²¡æœ‰
```

- class-validator ç”¨äº DTO çš„å±æ€§æ ¡éªŒã€‚

- class-transformer ç”¨äºå¯¹è±¡è½¬æ¢å’Œè‡ªåŠ¨è¿‡æ»¤å±æ€§ã€‚

è¿™ä¸¤ä¸ªåŒ…æ˜¯ NestJS DTO æ ¡éªŒçš„æ ‡å‡†ä¾èµ–ï¼Œå¿…é¡»ä¸€èµ·å®‰è£…ã€‚

**è‡ªåŠ¨åˆ é™¤éç™½åå•çš„å±æ€§**ï¼š

è‡ªåŠ¨åˆ é™¤é‚£äº›åœ¨éªŒè¯ç±»ä¸­æ²¡æœ‰ä»»ä½•è£…é¥°å™¨ï¼ˆå¦‚ `@IsString()`ã€`@IsInt()` ç­‰ï¼‰æ ‡è®°çš„å±æ€§ï¼Œéœ€è¦å°† `whitelist` è®¾ç½®ä¸º `true`ã€‚

```ts
whitelist: true
```

**å­˜åœ¨éç™½åå•å±æ€§æ—¶ç»ˆæ­¢è¯·æ±‚**ï¼š

å¦‚æœè¯·æ±‚ä¸­åŒ…å«æœªåœ¨ DTO ä¸­å®šä¹‰æˆ–æœªè¢«è£…é¥°å™¨æ ‡è®°çš„å±æ€§ï¼Œæƒ³è¦ç›´æ¥æŠ›å‡ºé”™è¯¯ï¼ˆè€Œä¸æ˜¯é™é»˜åˆ é™¤ï¼‰ï¼Œéœ€åŒæ—¶å¯ç”¨ï¼š

```ts
whitelist: true,
forbidNonWhitelisted: true
```

 **å¯ç”¨è¯·æ±‚æ•°æ®ç±»å‹è½¬æ¢**ï¼š

è‹¥å¸Œæœ›å°†å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼ˆå¦‚å­—ç¬¦ä¸²ï¼‰è‡ªåŠ¨è½¬æ¢ä¸ºç›®æ ‡ DTO ä¸­å£°æ˜çš„ç±»å‹ï¼ˆè£…é¥°å™¨ï¼‰ï¼ˆå¦‚ `number`ã€`boolean` ç­‰ï¼‰ï¼Œéœ€å¯ç”¨ï¼š

```ts
transform: true
```

**å¯ç”¨éšå¼ç±»å‹è½¬æ¢**ï¼ˆé…åˆ `transform`ï¼‰ï¼š

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`class-transformer` åªä¼šè½¬æ¢**æ˜¾å¼ç”¨ `@Type(() => Type)` è£…é¥°å™¨å£°æ˜çš„å±æ€§**ã€‚
è‹¥å¸Œæœ›æ ¹æ® DTO ä¸­çš„ç±»å‹æ¨æ–­ï¼Œè‡ªåŠ¨å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º `number`ã€`boolean` ç­‰ï¼Œéœ€å¯ç”¨ï¼š

```ts
transformOptions: {
  enableImplicitConversion: true
}
```

å¯ç”¨è¯¥é€‰é¡¹åï¼Œ**å³ä½¿æœªä½¿ç”¨ `@Type()` è£…é¥°å™¨**ï¼Œä¹Ÿä¼šè‡ªåŠ¨æ ¹æ®ç±»å‹è¿›è¡Œè½¬æ¢ã€‚
ä¾‹å¦‚ï¼š`{ age: "18" }` ä¼šè¢«è½¬æ¢ä¸º `age: 18`ï¼Œå‰ææ˜¯ `age` åœ¨ç±»ä¸­è¢«å®šä¹‰ä¸º `number` ç±»å‹ã€‚

**ç¤ºä¾‹é…ç½®**ï¼š

```ts
app.useGlobalPipes(new ValidationPipe({
  whitelist: true,
  forbidNonWhitelisted: true,
  transform: true,
  transformOptions: {
    enableImplicitConversion: true,
  },
}));
```

**æ‰©å±•**ï¼š

å¦‚æœæ‹…å¿ƒä¼ å…¥å€¼ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆä¾‹å¦‚ä¼ è¿›æ¥æ˜¯ `null`ã€æ•°ç»„ã€å­—ç¬¦ä¸²ç­‰éå¯¹è±¡ï¼‰ï¼Œå¯ä»¥å†åŠ ï¼š

```ts
forbidUnknownValues: true
```

Nest é»˜è®¤æ˜¯å…³é—­è¿™ä¸ªçš„ï¼Œä½†åœ¨å®‰å…¨åœºæ™¯ä¸‹ä½ å¯ä»¥å¯ç”¨ã€‚

å»ºè®®åœ¨DTO ä¸­å­—æ®µåŠ  `@Type(() => Number)` ï¼Œ æ˜¾å¼è½¬æ¢

**å°½ç®¡å¼€å¯äº† `enableImplicitConversion`ï¼Œ**ä½†åœ¨æŸäº›å¤æ‚ç»“æ„ï¼ˆå¦‚åµŒå¥—å¯¹è±¡ã€æ•°ç»„ï¼‰ä¸­ï¼Œå®ƒå¯èƒ½ä¸ä¼šè‡ªåŠ¨è½¬æ¢æˆåŠŸ**ï¼Œè¿™æ—¶æ¨èï¼š**

```ts
import { Type } from 'class-transformer';

export class CreateCatDto {
  @Type(() => Number)
  @IsInt()
  age: number;
}
```

æ˜¾å¼æ¯”éšå¼æ›´ä¿é™©ï¼Œç‰¹åˆ«æ˜¯åµŒå¥—æ•°ç»„ã€åµŒå¥—å¯¹è±¡ã€‚

å¯¹åµŒå¥—å¯¹è±¡/æ•°ç»„å¼€å¯è‡ªåŠ¨éªŒè¯ `@ValidateNested()` ï¼Œå¦åˆ™åµŒå¥—å¯¹è±¡ä¸ä¼šè‡ªåŠ¨æ ¡éªŒã€‚

```ts
export class CreateOwnerDto {
  @ValidateNested()
  @Type(() => CreateCatDto)
  cat: CreateCatDto;
}
```

## æŸ¥è¯¢å‚æ•°{#query-parameters}

åœ¨å¤„ç†è·¯ç”±ä¸­çš„æŸ¥è¯¢å‚æ•°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `@Query()` è£…é¥°å™¨ä»ä¼ å…¥è¯·æ±‚ä¸­æå–å®ƒä»¬ã€‚

```ts
@Get('a6')
demo6(@Query('name') name: string, @Query('age') age: number) {
    return `ä½ çš„å§“åæ˜¯${name}ï¼Œå¹´é¾„æ˜¯${age}`
}
```

`@Query()` è£…é¥°å™¨ç”¨äºä»æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­æå–å¯¹åº”çš„å€¼

```http
GET /test?name=bill&age=17
```

å¦‚æœä½ çš„åº”ç”¨éœ€è¦å¤„ç†æ›´å¤æ‚çš„æŸ¥è¯¢å‚æ•°ï¼Œæ¯”å¦‚ï¼š

```http
?filter[where][name]=John&filter[where][age]=30
?item[]=1&item[]=2
```

å®é™…å€¼ï¼š

`filter` æ˜¯ä¸€ä¸ªåµŒå¥—å¯¹è±¡ï¼Œåƒè¿™æ ·ï¼š

```js
filter = {
  where: {
    name: 'John',
    age: 30
  }
}
```

`item[]` æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç­‰ä»·äº `item = [1, 2]`

Nest é»˜è®¤çš„æŸ¥è¯¢å‚æ•°è§£æå™¨ï¼ˆåŸºäº Express æˆ– Fastifyï¼‰ä¸æ”¯æŒè¿™ç§å¤æ‚ç»“æ„ï¼Œå¦‚æœä½ ç›´æ¥ç”¨é»˜è®¤è®¾ç½®ï¼ŒNest æ— æ³•æ­£ç¡®è§£æè¿™äº›åµŒå¥—å¯¹è±¡å’Œæ•°ç»„ï¼Œå®ƒä»¬åªä¼šè¢«å½“æˆæ™®é€šå­—ç¬¦ä¸²å¤„ç†ã€‚

æ­¤æ—¶éœ€è¦**é…ç½®æŸ¥è¯¢å­—ç¬¦ä¸²è§£æå™¨**ï¼Œè®©å®ƒæ”¯æŒåµŒå¥—ç»“æ„ï¼š

å¦‚æœä½ ç”¨çš„æ˜¯ Expressï¼ˆNest é»˜è®¤ç”¨å®ƒï¼‰

```ts
const app = await NestFactory.create<NestExpressApplication>(AppModule);
app.set('query parser', 'extended');
```

è¿™æ · Express ä¼šç”¨å†…ç½®çš„â€œextendedâ€æ¨¡å¼è§£æå™¨ï¼ˆå…¶å®å°±æ˜¯ä¾èµ– `qs` åº“ï¼‰ï¼Œæ”¯æŒåµŒå¥—å¯¹è±¡å’Œæ•°ç»„ã€‚

å¦‚æœä½ ç”¨çš„æ˜¯ Fastifyï¼ˆå¦ä¸€ä¸ªæ›´å¿«çš„æ¡†æ¶ï¼‰

```ts
import qs from 'qs'; // ç¡®ä¿å®‰è£…ï¼šnpm install qs

const app = await NestFactory.create<NestFastifyApplication>(
  AppModule,
  new FastifyAdapter({
    querystringParser: (str) => qs.parse(str),
  }),
);
```

> [`qs`](https://www.npmjs.com/package/qs) æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æŸ¥è¯¢å­—ç¬¦ä¸²è§£æåº“ï¼Œå¯ä»¥å°†åµŒå¥—ç»“æ„ã€æ•°ç»„ç­‰å¤æ‚å‚æ•°ä» URL å­—ç¬¦ä¸²è½¬æ¢ä¸º JS å¯¹è±¡ï¼Œå®‰è£… `npm install qs`

## å¤„ç†é”™è¯¯{#handling-errors}

Nest å¸¦æœ‰ä¸€ä¸ªå†…ç½®çš„å¼‚å¸¸å±‚ï¼Œè´Ÿè´£å¤„ç†åº”ç”¨ä¸­æ‰€æœ‰æœªå¤„ç†çš„å¼‚å¸¸ã€‚å½“ä½ çš„åº”ç”¨ä»£ç æœªå¤„ç†å¼‚å¸¸æ—¶ï¼Œè¯¥å±‚ä¼šæ•è·è¯¥å¼‚å¸¸ï¼Œç„¶åè‡ªåŠ¨å‘é€é€‚å½“çš„ç”¨æˆ·å‹å¥½å“åº”ï¼Œæ­¤æ“ä½œç”±å†…ç½®çš„å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨æ‰§è¡Œï¼Œè¯¥è¿‡æ»¤å™¨å¤„ç† `HttpException` ç±»å‹ï¼ˆåŠå…¶å­ç±»ï¼‰çš„å¼‚å¸¸ã€‚å½“å¼‚å¸¸æ— æ³•è¯†åˆ«æ—¶ï¼ˆæ—¢ä¸æ˜¯ `HttpException` ä¹Ÿä¸æ˜¯ç»§æ‰¿è‡ª `HttpException` çš„ç±»ï¼‰ï¼Œå†…ç½®å¼‚å¸¸è¿‡æ»¤å™¨ä¼šç”Ÿæˆä»¥ä¸‹é»˜è®¤ JSON å“åº”ï¼š

```json
{
  "statusCode": 500,
  "message": "Internal server error"
}
```

> NestJS çš„å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨**éƒ¨åˆ†æ”¯æŒ [`http-errors`](https://github.com/jshttp/http-errors) è¿™ä¸ªç¬¬ä¸‰æ–¹åº“**ã€‚
> åªè¦ä½ æŠ›å‡ºçš„é”™è¯¯å¯¹è±¡é‡Œ**åŒ…å« `statusCode` å’Œ `message` è¿™ä¸¤ä¸ªå­—æ®µ**ï¼ŒNest å°±èƒ½è¯†åˆ«å®ƒï¼Œå¹¶æŠŠå®ƒä½œä¸ºä¸€ä¸ªâ€œåˆæ³•çš„ HTTP å¼‚å¸¸â€è¿”å›ç»™å‰ç«¯ã€‚
>
> ä¹Ÿå°±æ˜¯è¯´ï¼š**ä½ ä¸ä¸€å®šéå¾—æŠ› Nest çš„ `HttpException`**ï¼Œåªè¦æŠ›å‡ºä¸€ä¸ªç»“æ„åƒè¿™æ ·çš„å¯¹è±¡ï¼š
>
> ```js
> throw { statusCode: 404, message: 'Not Found' };
> ```
>
> NestJS å°±ä¼šæŠŠå®ƒå½“æˆæ­£å¸¸çš„ HTTP å“åº”ï¼Œè€Œ**ä¸ä¼šé»˜è®¤å˜æˆ 500 æœåŠ¡å™¨é”™è¯¯ï¼ˆInternalServerErrorï¼‰**
>
> ```js
> // ä¾‹å­
> import createError from 'http-errors';
> 
> @Get()
> getSomething() {
>   throw createError(403, 'ä½ æ— æƒè®¿é—®è¯¥èµ„æº');
> }
> ```
>
> Nest èƒ½è¯†åˆ«è¿™ä¸ªå¼‚å¸¸ï¼Œå¹¶è¿”å›ï¼š
>
> ```json
> {
>   "statusCode": 403,
>   "message": "ä½ æ— æƒè®¿é—®è¯¥èµ„æº"
> }
> 
> ```
>
> ä½ å¯ä»¥ä¸ç”¨å†™ `new HttpException()`ï¼Œåªè¦ä½ æŠ›å‡ºçš„å¯¹è±¡é‡Œå¸¦æœ‰ `statusCode` å’Œ `message`ï¼ŒNest ä¹Ÿèƒ½å½“æˆåˆæ³•å¼‚å¸¸æ¥å¤„ç†å’Œå“åº”ã€‚
>
> å¯¹äºä½¿ç”¨ `http-errors`ã€`Boom` ç­‰åº“çš„äººæ¥è¯´éå¸¸æ–¹ä¾¿

**æŠ›å‡ºæ ‡å‡†å¼‚å¸¸**

Nest æä¾›äº†ä¸€ä¸ªå†…ç½®çš„ `HttpException` ç±»ï¼Œä½äº `@nestjs/common` åŒ…ä¸­ã€‚å¯¹äºå…¸å‹çš„åŸºäº HTTP REST æˆ– GraphQL çš„åº”ç”¨æ¥è¯´ï¼Œæœ€ä½³å®è·µæ˜¯åœ¨é‡åˆ°é”™è¯¯æ—¶ï¼Œå‘é€æ ‡å‡†çš„ HTTP å“åº”ç»™å®¢æˆ·ç«¯ï¼Œä»¥æ˜ç¡®è¡¨ç¤ºé”™è¯¯çŠ¶æ€ï¼›

ä¹Ÿå°±æ˜¯è¯´ï¼šå½“ä½ çš„æ¥å£å‡ºé”™æ—¶ï¼Œä¸è¦ç›´æ¥æŠ›å‡ºæ™®é€šé”™è¯¯ï¼Œè€Œæ˜¯ç”¨ Nest æä¾›çš„ `HttpException`ï¼Œè®©æœåŠ¡å™¨èƒ½è¿”å›ç¬¦åˆ HTTP è§„èŒƒçš„é”™è¯¯çŠ¶æ€ç å’Œä¿¡æ¯ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯å¤„ç†ã€‚

```ts
@Get()
async findAll() {
  throw new HttpException('Forbidden', HttpStatus.FORBIDDEN);
}
```

> `HttpStatus`æ˜¯ä¸€ä¸ªä» `@nestjs/common` åŒ…å¯¼å…¥çš„è¾…åŠ©æšä¸¾ã€‚

```json
{
  "statusCode": 403,
  "message": "Forbidden"
}
```

`HttpException` æ„é€ å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå¿…é€‰å‚æ•°æ¥å†³å®šå“åº”å†…å®¹ï¼š

- `response` å‚æ•°å®šä¹‰äº† JSON å“åº”ä½“ï¼Œå¯ä»¥æ˜¯å¦‚ä¸‹æ‰€è¿°çš„ `string` æˆ– `object` ç±»å‹ã€‚
- `status` å‚æ•°å®šä¹‰äº† [HTTP çŠ¶æ€ç ](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Status)

é»˜è®¤æƒ…å†µä¸‹ï¼ŒJSON å“åº”ä½“åŒ…å«ä¸¤ä¸ªå±æ€§ï¼š

- `statusCode`ï¼šé»˜è®¤ä¸º `status` å‚æ•°ä¸­æä¾›çš„ HTTP çŠ¶æ€ç 
- `message`ï¼šåŸºäº `status` çš„ HTTP é”™è¯¯ç®€çŸ­æè¿°

è‹¥è¦ä»…è¦†ç›– JSON å“åº”ä½“ä¸­çš„æ¶ˆæ¯éƒ¨åˆ†ï¼Œè¯·åœ¨ `response` å‚æ•°ä¸­ä¼ å…¥å­—ç¬¦ä¸²ã€‚è‹¥è¦è¦†ç›–æ•´ä¸ª JSON å“åº”ä½“ï¼Œåˆ™åœ¨ `response` å‚æ•°ä¸­ä¼ å…¥å¯¹è±¡ã€‚Nest ä¼šå°†è¯¥å¯¹è±¡åºåˆ—åŒ–åä½œä¸º JSON å“åº”ä½“è¿”å›ã€‚

ç¬¬äºŒä¸ªæ„é€ å‚æ•° `status` åº”ä¸ºæœ‰æ•ˆçš„ HTTP çŠ¶æ€ç ã€‚æœ€ä½³å®è·µæ˜¯ä½¿ç”¨ä» `@nestjs/common` å¯¼å…¥çš„ `HttpStatus` æšä¸¾ã€‚

`HttpException` çš„ **ç¬¬ä¸‰ä¸ªå‚æ•° `options`ï¼ˆé€šå¸¸ç”¨äº `cause`ï¼‰** æ˜¯ä¸ºäº†æä¾›**é¢å¤–ä¸Šä¸‹æ–‡ä¿¡æ¯**ï¼Œ**ä¸ä¼šè¢«åºåˆ—åŒ–è¿›å“åº”ä½“**ï¼Œä»…ç”¨äºæ—¥å¿—ã€è°ƒè¯•æˆ–å†…éƒ¨ä¼ é€’ã€‚

```js
throw new HttpException(
  'ç”¨æˆ·ä¸å­˜åœ¨',
  HttpStatus.NOT_FOUND,
  {
    cause: new Error('User ID 123 not found in database')
  }
);
```

å®é™…å®¢æˆ·ç«¯æ”¶åˆ°çš„å“åº”æ˜¯

```json
{
  "statusCode": 404,
  "message": "ç”¨æˆ·ä¸å­˜åœ¨"
}
```

ä½†åœ¨æœåŠ¡ç«¯ä½ å¯ä»¥é€šè¿‡ `exception.cause` æ‹¿åˆ°æ›´å¤šä¿¡æ¯ã€‚

**å¼‚å¸¸æ—¥å¿—è®°å½•**

åœ¨ NestJS ä¸­ï¼Œ**é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼‚å¸¸è¿‡æ»¤å™¨ä¸ä¼šè®°å½•å†…ç½®å¼‚å¸¸**ï¼Œæ¯”å¦‚ï¼š

- `HttpException`ï¼ˆä»¥åŠç»§æ‰¿è‡ªå®ƒçš„è‡ªå®šä¹‰å¼‚å¸¸ï¼‰
- `WsException`ï¼ˆWebSocket å¼‚å¸¸ï¼‰
- `RpcException`ï¼ˆå¾®æœåŠ¡å¼‚å¸¸ï¼‰

å½“è¿™ç±»å¼‚å¸¸è¢«æŠ›å‡ºæ—¶ï¼Œå®ƒä»¬ä¸ä¼šåœ¨æ§åˆ¶å°ä¸­è‡ªåŠ¨æ‰“å°æ—¥å¿—ã€‚åŸå› æ˜¯ï¼š

**å®ƒä»¬è¢«è§†ä¸ºâ€œæ­£å¸¸çš„åº”ç”¨æµç¨‹â€**ï¼Œå°±åƒ HTTP ä¸­ 404 æˆ– 403 æ˜¯å¯é¢„æœŸçš„ï¼Œä¸å±äºç¨‹åºå‡ºé”™ã€‚

å¼‚å¸¸åŸºç¡€ç±»ï¼š`IntrinsicException`ï¼Œè¿™äº›å†…ç½®å¼‚å¸¸éƒ½ç»§æ‰¿è‡ªä¸€ä¸ªåŸºç¡€ç±»ï¼š`IntrinsicException`ï¼Œå®ƒæ¥è‡ª `@nestjs/common` åŒ…ã€‚

è¿™ä¸ªç±»çš„å­˜åœ¨æ˜¯ä¸ºäº†å¸®åŠ©æ¡†æ¶åŒºåˆ†ï¼š

âœ… **æ­£å¸¸ä¸šåŠ¡æµç¨‹ä¸­çš„å¼‚å¸¸**ï¼ˆå¦‚è®¿é—®å—é™ã€å‚æ•°ä¸åˆæ³•ï¼‰

âŒ **éé¢„æœŸçš„ç¨‹åºé”™è¯¯**ï¼ˆå¦‚æ•°æ®åº“è¿æ¥å¤±è´¥ã€ç©ºæŒ‡é’ˆï¼‰

å¦‚æœä½ æƒ³è®°å½•è¿™äº›å¼‚å¸¸ï¼Œå¯ä»¥é€šè¿‡**ç¼–å†™è‡ªå®šä¹‰å¼‚å¸¸è¿‡æ»¤å™¨ï¼ˆException Filterï¼‰**ï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­æ‰‹åŠ¨è®°å½•ã€æ ¼å¼åŒ–æˆ–æ‰©å±•è¿™äº›å¼‚å¸¸ã€‚

**è‡ªå®šä¹‰å¼‚å¸¸ç±»**

ä¸»è¦ç”¨äº**å°è£…å¸¸è§çš„çŠ¶æ€å’Œé€»è¾‘ï¼Œé¿å…é‡å¤ä»£ç **

ä¸ç”¨æ¯æ¬¡éƒ½å†™è¿™ä¸€å †ï¼š

```js
throw new HttpException('Forbidden', HttpStatus.FORBIDDEN);
```

å¯ä»¥ç›´æ¥å†™ï¼š

```js
throw new ForbiddenException();
```

æ›´çŸ­ã€æ›´è¯­ä¹‰åŒ–ã€å¯è¯»æ€§æ›´å¼ºã€‚

å½¢æˆç»Ÿä¸€çš„å¼‚å¸¸ä½“ç³»ï¼ˆæ›´æ˜“ç»´æŠ¤ï¼‰ï¼Œæ¯”å¦‚æœ‰è¿™äº›é”™è¯¯ï¼š

- ç”¨æˆ·æœªç™»å½• â†’ `UnauthorizedException`
- ç”¨æˆ·è¢«å°ç¦ â†’ `UserBannedException`
- å‚æ•°é”™è¯¯ â†’ `InvalidParamException`

ç”¨è‡ªå®šä¹‰å¼‚å¸¸å°è£…åï¼Œä»£ç é‡Œå°±å¾ˆæ¸…æ™°ï¼Œå¼‚å¸¸å±‚æ¬¡ä¹Ÿæ¸…æ¥šï¼Œ**ä»¥åè¦ç»Ÿä¸€å¤„ç†ï¼ˆæ—¥å¿—è®°å½•ã€å“åº”æ ¼å¼ï¼‰éå¸¸æ–¹ä¾¿ã€‚**

è‡ªå®šä¹‰å“åº”ç»“æ„ï¼šé”™è¯¯ç ã€è¯­è¨€ã€å…ƒæ•°æ®ç­‰

```js
export class UserBannedException extends HttpException {
  constructor(reason = 'ä½ å·²è¢«å°å·') {
    super(
      { message: reason, errorCode: 1004 },
      HttpStatus.FORBIDDEN,
    );
  }
}
```

è¿”å›å‰ç«¯çš„å†…å®¹æ›´æœ‰ä¸šåŠ¡å«ä¹‰ï¼š

```json
{
  "message": "ä½ å·²è¢«å°å·",
  "errorCode": 1004,
  "statusCode": 403
}
```

**ä¾¿äºåœ¨å¼‚å¸¸è¿‡æ»¤å™¨ä¸­æŒ‰ç±»å‹åˆ†ç±»å¤„ç†**

```js
if (exception instanceof UserBannedException) {
  logger.warn('ç”¨æˆ·å°ç¦ï¼š' + exception.message);
}	
```

è‡ªå®šä¹‰å¼‚å¸¸ç±»çš„æ ¸å¿ƒä½œç”¨å°±æ˜¯ï¼š**æŠŠå¸¸ç”¨çš„å¼‚å¸¸ä¿¡æ¯å°è£…æˆå¯å¤ç”¨çš„â€œçŠ¶æ€ç±»â€**ï¼Œ
è®©ä½ åœ¨æŠ›å¼‚å¸¸æ—¶ä¸ç”¨é‡å¤å†™ã€ç»“æ„ç»Ÿä¸€ã€å¯è¯»æ€§é«˜ã€æ˜“äºåæœŸæ‰©å±•ã€‚

**å†…ç½® HTTP å¼‚å¸¸**

Nest æä¾›äº†ä¸€ç»„ç»§æ‰¿è‡ªåŸºç¡€ `HttpException` çš„æ ‡å‡†å¼‚å¸¸ã€‚è¿™äº›å¼‚å¸¸æ¥è‡ª `@nestjs/common` åŒ…ï¼Œä»£è¡¨äº†è®¸å¤šæœ€å¸¸è§çš„ HTTP å¼‚å¸¸ï¼š

| å¼‚å¸¸ç±»åç§°                         | å¯¹åº” HTTP çŠ¶æ€ç  | æè¿°                       |
| ---------------------------------- | ---------------- | -------------------------- |
| `BadRequestException`              | 400              | è¯·æ±‚æ— æ•ˆï¼ˆå‚æ•°é”™è¯¯ç­‰ï¼‰     |
| `UnauthorizedException`            | 401              | æœªæˆæƒ/æœªç™»å½•              |
| `ForbiddenException`               | 403              | å·²ç™»å½•ä½†æ— æƒé™             |
| `NotFoundException`                | 404              | èµ„æºæœªæ‰¾åˆ°                 |
| `MethodNotAllowedException`        | 405              | ä¸æ”¯æŒçš„è¯·æ±‚æ–¹æ³•           |
| `NotAcceptableException`           | 406              | æœåŠ¡ç«¯æ— æ³•æ»¡è¶³è¯·æ±‚å¤´çš„éœ€æ±‚ |
| `RequestTimeoutException`          | 408              | è¯·æ±‚è¶…æ—¶                   |
| `ConflictException`                | 409              | èµ„æºå†²çªï¼ˆå¦‚ç”¨æˆ·åå·²å­˜åœ¨ï¼‰ |
| `GoneException`                    | 410              | èµ„æºå·²è¢«æ°¸ä¹…åˆ é™¤           |
| `PayloadTooLargeException`         | 413              | è¯·æ±‚ä½“å¤ªå¤§                 |
| `UnsupportedMediaTypeException`    | 415              | ä¸æ”¯æŒçš„è¯·æ±‚å†…å®¹ç±»å‹       |
| `UnprocessableEntityException`     | 422              | è¯·æ±‚æ ¼å¼æ­£ç¡®ä½†è¯­ä¹‰é”™è¯¯     |
| `PreconditionFailedException`      | 412              | è¯·æ±‚å¤´æ¡ä»¶ä¸æ»¡è¶³           |
| `InternalServerErrorException`     | 500              | æœåŠ¡ç«¯å†…éƒ¨é”™è¯¯             |
| `NotImplementedException`          | 501              | åŠŸèƒ½æœªå®ç°                 |
| `BadGatewayException`              | 502              | ç½‘å…³é”™è¯¯                   |
| `ServiceUnavailableException`      | 503              | æœåŠ¡ä¸å¯ç”¨                 |
| `GatewayTimeoutException`          | 504              | ç½‘å…³è¶…æ—¶                   |
| `HttpVersionNotSupportedException` | 505              | ä¸æ”¯æŒçš„ HTTP åè®®ç‰ˆæœ¬     |
| `ImATeapotException`               | 418              | ğŸµ I'm a teapotï¼ˆå½©è›‹ç”¨ï¼‰   |

æ‰€æœ‰å†…ç½®å¼‚å¸¸è¿˜å¯ä»¥é€šè¿‡ `options` å‚æ•°æä¾›é”™è¯¯ `cause` å’Œé”™è¯¯æè¿°ï¼š

```ts
new NotFoundException('ç”¨æˆ·ä¸å­˜åœ¨', { cause: new Error('DB lookup failed') });
```

| å‚æ•°å     | ç±»å‹              | ä½œç”¨                                     |
| ---------- | ----------------- | ---------------------------------------- |
| `response` | `string \| object`   | è‡ªå®šä¹‰è¿”å›æ¶ˆæ¯ä½“ï¼ˆmessage å­—ç¬¦ä¸²æˆ–å¯¹è±¡ï¼‰ |
| `options`  | `{ cause?: any }` | æä¾›å†…éƒ¨å¼‚å¸¸è¯¦æƒ…ï¼ˆä¸ä¼šè¿”å›ç»™å‰ç«¯ï¼‰       |

> åœ¨**çœŸå®å¼€å‘å’Œæ—¥å¿—è¿½è¸ªåœºæ™¯**ä¸­ï¼Œå»ºè®®æ€»æ˜¯ä½¿ç”¨ `new Error(...)`ï¼Œå®ƒæä¾›å †æ ˆä¿¡æ¯ï¼Œå¯¹æ’é”™éå¸¸æœ‰å¸®åŠ©ã€‚

`HttpException` æ„é€ å‡½æ•°æ ‡å‡†ï¼ˆTypeScript ç±»å‹å®šä¹‰ï¼‰ï¼š

```ts
class HttpException extends Error {
  constructor(
    response: string | Record<string, any>,
    status: number,
    options?: {
      cause?: unknown;
      description?: string;
    }
  );
}
```

| å‚æ•°å     | ç±»å‹                                        | æ˜¯å¦å¿…é¡» | è¯´æ˜                                                         |
| ---------- | ------------------------------------------- | -------- | ------------------------------------------------------------ |
| `response` | `string` or `object`                        | âœ… å¿…éœ€   | å“åº”ä½“ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼ˆä½œä¸º messageï¼‰æˆ–å¯¹è±¡ï¼ˆå®Œæ•´ç»“æ„ï¼‰       |
| `status`   | `number`                                    | âœ… å¿…éœ€   | HTTP çŠ¶æ€ç ï¼ˆæ¨èç”¨ `HttpStatus.X` æšä¸¾ï¼‰                    |
| `options`  | `{ cause?: unknown, description?: string }` | âŒ å¯é€‰   | é™„åŠ ä¿¡æ¯ã€‚ä¸ä¼šå½±å“å“åº”ç»“æ„ä¸­çš„ `message`ï¼Œä½†ä¼šå½±å“ `error` å­—æ®µå’Œæ—¥å¿—è®°å½• |

```ts
throw new BadRequestException('Something bad happened', {
  cause: new Error(),
  description: 'Some error description',
});

// è¿”å›

{
  "message": "Something bad happened",
  "error": "Some error description",
  "statusCode": 400
}
```

**å¼‚å¸¸è¿‡æ»¤å™¨**

è™½ç„¶å†…ç½®å¼‚å¸¸è¿‡æ»¤å™¨èƒ½è‡ªåŠ¨å¤„ç†å¤šæ•°åœºæ™¯ï¼Œä½†åœ¨éœ€è¦**å®Œå…¨æ§åˆ¶**å¼‚å¸¸å¤„ç†æ—¶ï¼ˆå¦‚åŠ¨æ€æ—¥å¿—è®°å½•æˆ–è‡ªå®šä¹‰ JSON å“åº”ç»“æ„ï¼‰ï¼Œåº”ä½¿ç”¨å¼‚å¸¸è¿‡æ»¤å™¨ã€‚å®ƒå…è®¸ç²¾ç¡®æ§åˆ¶æ‰§è¡Œæµç¨‹å’Œå®¢æˆ·ç«¯å“åº”å†…å®¹ã€‚

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¼‚å¸¸è¿‡æ»¤å™¨ï¼Œè´Ÿè´£æ•è· `HttpException` ç±»çš„å®ä¾‹å¼‚å¸¸ï¼Œå¹¶ä¸ºå®ƒä»¬å®ç°è‡ªå®šä¹‰å“åº”é€»è¾‘ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦è®¿é—®åº•å±‚å¹³å°çš„ `Request` å’Œ `Response` å¯¹è±¡ã€‚æˆ‘ä»¬å°†è®¿é—® `Request` å¯¹è±¡ä»¥æå–åŸå§‹ `url` å¹¶å°†å…¶åŒ…å«åœ¨æ—¥å¿—ä¿¡æ¯ä¸­ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ `Response` å¯¹è±¡é€šè¿‡ `response.json()` æ–¹æ³•ç›´æ¥æ§åˆ¶å‘é€çš„å“åº”ã€‚

```ts
@@filename(http-exception.filter)
import { ExceptionFilter, Catch, ArgumentsHost, HttpException } from '@nestjs/common';
import { Request, Response } from 'express';

@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();
    const status = exception.getStatus();

    response
      .status(status)
      .json({
        statusCode: status,
        timestamp: new Date().toISOString(),
        path: request.url,
      });
  }
}
```

 æ‰€æœ‰å¼‚å¸¸è¿‡æ»¤å™¨éƒ½åº”è¯¥å®ç°æ³›å‹æ¥å£ `ExceptionFilter<T>`ï¼Œè¿™æ„å‘³ç€ä½ éœ€è¦æä¾›ä¸€ä¸ªå…·æœ‰ç‰¹å®šç­¾åçš„ `catch(exception: T, host: ArgumentsHost)` æ–¹æ³•ï¼Œ  å…¶ä¸­ï¼Œ`T` ä»£è¡¨ä½ æƒ³è¦æ•è·çš„å¼‚å¸¸ç±»å‹ã€‚

`ExceptionFilter`çš„åº•å±‚ï¼š

```ts
export interface ExceptionFilter<T = any> {
    catch(exception: T, host: ArgumentsHost): any;
}
```

æ‰€ä»¥è¦è¿™æ ·ï¼š

```ts
export class MyFilter implements ExceptionFilter<HttpException> {
  catch(exception, host: ArgumentsHost) {
    // ...
  }
}
```

> å¦‚æœæ‚¨ä½¿ç”¨ `@nestjs/platform-fastify`ï¼Œå¯ä»¥ç”¨ `response.send()` æ›¿ä»£ `response.json()`ã€‚åˆ«å¿˜äº†ä» `fastify` å¯¼å…¥æ­£ç¡®çš„ç±»å‹ã€‚

`@Catch()` è£…é¥°å™¨
æŒ‡å®šè¦æ•è·çš„å¼‚å¸¸ç±»å‹ï¼ˆæ”¯æŒå¤šå‚æ•°ï¼Œå¦‚ `@Catch(HttpException, CustomError)`ï¼‰

**å‚æ•° host**

`catch()` æ–¹æ³•çš„ä¸¤ä¸ªå‚æ•°ï¼š

- `exception`ï¼šå°±æ˜¯å½“å‰æ•è·åˆ°çš„å¼‚å¸¸å¯¹è±¡ã€‚
- `host`ï¼šæ˜¯ä¸€ä¸ª `ArgumentsHost` å®ä¾‹ï¼Œå®ƒæ˜¯ Nest æä¾›çš„ä¸€ä¸ªå¼ºå¤§å·¥å…·ã€‚

å¯ä»¥é€šè¿‡ `ArgumentsHost` è·å–åŸå§‹çš„è¯·æ±‚å¤„ç†ç›¸å…³å¯¹è±¡ï¼Œæ¯”å¦‚ HTTP è¯·æ±‚æ—¶çš„ `Request` å’Œ `Response`ï¼Œè¿™åœ¨å¼‚å¸¸è¿‡æ»¤å™¨ä¸­éå¸¸æœ‰ç”¨ã€‚

æˆ‘ä»¬ä½¿ç”¨äº† `ArgumentsHost` æä¾›çš„è¾…åŠ©æ–¹æ³•ï¼Œæ¯”å¦‚ï¼š

```ts
host.switchToHttp().getRequest();
host.switchToHttp().getResponse();
```

**å¹³å°æŠ½è±¡è®¿é—®**ï¼š

```ts
const ctx = host.switchToHttp();
// ç±»å‹å‚æ•°<Request>ç¡®ä¿TSç±»å‹å®‰å…¨
const request = ctx.getRequest<Request>();  // åº•å±‚æ¡†æ¶çš„Requestå¯¹è±¡
const response = ctx.getResponse<Response>(); // åº•å±‚æ¡†æ¶çš„Responseå¯¹è±¡
```

**å“åº”æ§åˆ¶**

ç›´æ¥æ“ä½œå¹³å°åŸç”Ÿå“åº”å¯¹è±¡ï¼Œå®Œå…¨è‡ªå®šä¹‰JSONç»“æ„

```ts
response.status(status).json({...});
```

**å¼‚å¸¸å…ƒæ•°æ®æå–**

```ts
exception.getStatus();  // è·å–HTTPçŠ¶æ€ç 
exception.message;     // è·å–åŸå§‹é”™è¯¯æ¶ˆæ¯
```

ç”¨æ¥è·å–å½“å‰å‘ç”Ÿå¼‚å¸¸çš„è¯·æ±‚ï¼ˆrequestï¼‰å’Œå“åº”ï¼ˆresponseï¼‰å¯¹è±¡ã€‚

ä¸ºä»€ä¹ˆè¦ç”¨ `ArgumentsHost` è¿™ç§â€œ**é—´æ¥**â€çš„æ–¹å¼è€Œä¸æ˜¯ç›´æ¥ä¼ è¯·æ±‚ï¼Ÿ

è¿™æ˜¯ä¸ºäº†è®©å¼‚å¸¸è¿‡æ»¤å™¨èƒ½å…¼å®¹ **æ‰€æœ‰ä¸Šä¸‹æ–‡ç±»å‹**ï¼Œä¸ä»…ä»…æ˜¯ HTTP è¯·æ±‚ã€‚æ¯”å¦‚ï¼š

- **HTTP æ¨¡å¼**
- **WebSocket**
- **å¾®æœåŠ¡ï¼ˆgRPCã€MQ ç­‰ï¼‰**

é€šè¿‡ `ArgumentsHost`ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª **é€šç”¨çš„å¼‚å¸¸è¿‡æ»¤å™¨**ï¼Œé€‚é…ä¸åŒåœºæ™¯ï¼Œä¸å¿…ä¸ºæ¯ä¸ªåœºæ™¯å†™ä¸€ä»½è¿‡æ»¤é€»è¾‘ã€‚

`ArgumentsHost` æ˜¯ä¸€ä¸ªæŠ½è±¡çš„ä¸Šä¸‹æ–‡å®¹å™¨ï¼Œè®©æˆ‘ä»¬èƒ½ä»ä¸­è·å–å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­çš„å„ç§åŸå§‹å¯¹è±¡ã€‚å®ƒçš„è®¾è®¡æ˜¯ä¸ºäº†æ”¯æŒå¤šç§é€šä¿¡åè®®ï¼Œè€Œä¸ä»…ä»…æ˜¯ HTTPã€‚é€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥å†™å‡ºé«˜åº¦å¤ç”¨çš„é€šç”¨å¼‚å¸¸è¿‡æ»¤å™¨ã€‚

`ArgumentsHost` æä¾›è®¿é—®å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡çš„æ–¹æ³•ï¼š

```ts
const httpCtx = host.switchToHttp(); // HTTPä¸Šä¸‹æ–‡
const rpcCtx = host.switchToRpc();   // å¾®æœåŠ¡ä¸Šä¸‹æ–‡
const wsCtx = host.switchToWs();     // WebSocketä¸Šä¸‹æ–‡
```

**ç»‘å®šè¿‡æ»¤å™¨**

`@UseFilters()` è£…é¥°å™¨æ˜¯ä» `@nestjs/common` åŒ…ä¸­å¯¼å…¥çš„ã€‚

`@UseFilters()` è£…é¥°å™¨ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰å¼‚å¸¸è¿‡æ»¤å™¨åº”ç”¨åˆ°æŸä¸ªæ§åˆ¶å™¨æˆ–å…·ä½“è·¯ç”±æ–¹æ³•ä¸Šã€‚

å®ƒçš„ç”¨æ³•ä¸ `@Catch()` è£…é¥°å™¨ç±»ä¼¼ï¼ŒåŒºåˆ«æ˜¯ï¼š

- `@Catch()` æ˜¯**å®šä¹‰**è¿‡æ»¤å™¨æ—¶ä½¿ç”¨çš„ï¼ˆç»‘å®šå¼‚å¸¸ç±»å‹ï¼‰ï¼›
- `@UseFilters()` æ˜¯**åº”ç”¨**è¿‡æ»¤å™¨æ—¶ä½¿ç”¨çš„ï¼ˆå‘Šè¯‰ Nestï¼šå‡ºé”™æ—¶ç”¨å“ªä¸ªè¿‡æ»¤å™¨ï¼‰ã€‚

åœ¨ `@UseFilters()` ä¸­å¯ä»¥ï¼š

- ä¼ å…¥ä¸€ä¸ªè¿‡æ»¤å™¨çš„**å®ä¾‹**ï¼ˆ`new HttpExceptionFilter()`ï¼‰ï¼›
- æˆ–è€…ç›´æ¥ä¼ å…¥è¿‡æ»¤å™¨**ç±»**ï¼ˆ`HttpExceptionFilter`ï¼‰â€”â€”è¿™æ · Nest ä¼šè‡ªåŠ¨å¸®ä½ å®ä¾‹åŒ–ï¼Œå¹¶æ”¯æŒä¾èµ–æ³¨å…¥ã€‚

 æ¨èä½¿ç”¨â€œç±»â€çš„æ–¹å¼ï¼ˆå³ä¸åŠ  `new`ï¼‰ï¼Œè¿™æ ·æ›´ç¬¦åˆ Nest çš„ä¾èµ–æ³¨å…¥æœºåˆ¶ï¼Œä¹Ÿæ›´æ˜“ç»´æŠ¤ã€‚

> å…³äºç›´æ¥ä¼ å…¥ä¸€ä¸ªç±»æ”¯æŒä¾èµ–æ³¨å…¥ï¼š
>
> å½“ä½ ä¼ å…¥çš„æ˜¯ä¸€ä¸ª**ç±»ï¼ˆClassï¼‰**è€Œä¸æ˜¯**å®ä¾‹ï¼ˆnew å‡ºæ¥çš„å¯¹è±¡ï¼‰**æ—¶ï¼ŒNest ä¼šï¼š
>
> - **è‡ªåŠ¨å®ä¾‹åŒ–**è¿™ä¸ªç±»
> - å¦‚æœè¿™ä¸ªç±»çš„æ„é€ å‡½æ•°ä¾èµ–äº†å…¶ä»–æœåŠ¡ï¼ŒNest ä¼š**è‡ªåŠ¨æ³¨å…¥è¿™äº›ä¾èµ–**
> - Nest è¿˜å¯ä»¥è‡ªåŠ¨ç®¡ç†å®ƒçš„**ç”Ÿå‘½å‘¨æœŸ**ï¼ˆæ¯”å¦‚æ˜¯å•ä¾‹ã€æ¯ä¸ªè¯·æ±‚ä¸€ä¸ªç­‰ï¼‰
>
>  æ‰€ä»¥ï¼Œä¼ ç±»çš„æ–¹å¼æ‰å« â€œ**æ”¯æŒä¾èµ–æ³¨å…¥**â€ã€‚
>
> å¦‚æœæ˜¯ `@UseFilters(new HttpExceptionFilter())` **è‡ªå·±åˆ›å»ºäº†ä¸€ä¸ªå®ä¾‹**ï¼ŒNest å®Œå…¨æ²¡æœºä¼šå¸®ä½ ï¼š
>
> - æ³¨å…¥æ„é€ å‡½æ•°é‡Œå¯èƒ½éœ€è¦çš„ä¾èµ–æœåŠ¡
> - ç®¡ç†è¿™ä¸ªå®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸï¼ˆæ¯”å¦‚æŒ‰ä½œç”¨åŸŸç¼“å­˜ã€é”€æ¯ï¼‰
> - åšä¸€äº›å†…éƒ¨çš„æ³¨å†Œå·¥ä½œ

å°½é‡ä½¿ç”¨**ç±»å**æ¥æ³¨å†Œè¿‡æ»¤å™¨ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ `new` ä¸€ä¸ªè¿‡æ»¤å™¨å®ä¾‹ã€‚è¿™æ ·å¯ä»¥**å‡å°‘å†…å­˜å¼€é”€**ï¼Œå› ä¸º Nest èƒ½å¤Ÿå¯¹è¿™ä¸ªç±»çš„å®ä¾‹è¿›è¡Œ**å¤ç”¨å’Œæ‰˜ç®¡**ï¼Œåœ¨åŒä¸€ä¸ªæ¨¡å—ä¸­é¿å…é‡å¤åˆ›å»ºå¤šä¸ªå®ä¾‹ã€‚

**@Catch() è£…é¥°å™¨ä¹Ÿæ¨èä¼ å…¥ç±»**ï¼Œè€Œä¸æ˜¯å®ä¾‹ï¼Œè¿™ä¸ `@UseFilters()` çš„æœ€ä½³å®è·µä¸€è‡´ã€‚

```ts
@UseFilters(HttpExceptionFilter) // âœ… æ¨è
@UseFilters(new HttpExceptionFilter()) // âŒ ä¸æ¨è
```

**é™ä½å†…å­˜æ¶ˆè€—**ï¼š

- å¦‚æœä½  `new`ï¼Œæ¯æ¬¡ç”¨ä¸€æ¬¡å°±åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œé€ æˆ**é‡å¤å®ä¾‹**ã€‚
- å¦‚æœä½ äº¤ç»™ Nest ç®¡ç†ï¼Œå®ƒåªä¼šåˆ›å»º**ä¸€ä¸ªå…±äº«å®ä¾‹ï¼ˆå•ä¾‹ï¼‰**ï¼ˆé»˜è®¤æ˜¯ `Scope.DEFAULT`ï¼‰ï¼Œå¤šä¸ªæ§åˆ¶å™¨æˆ–æ–¹æ³•å¯å…±ç”¨ï¼Œ**èŠ‚çœèµ„æº**ã€‚

**Nest å¯ä»¥è½»æ¾å¤ç”¨ç›¸åŒç±»çš„å®ä¾‹**

- Nest æœ‰è‡ªå·±çš„ DI å®¹å™¨ï¼Œå®ƒä¼š**ç¼“å­˜**å·²ç»åˆ›å»ºå¥½çš„å•ä¾‹ã€‚
- å¦‚æœä½ ç”¨ç±»åæ³¨å†Œï¼ŒNest ä¼šå¤ç”¨å·²æœ‰çš„ã€‚
- ä½ æ‰‹åŠ¨ newï¼Œå®ƒå°±ç»•å¼€äº†è¿™ä¸ªæœºåˆ¶ï¼Œç›¸å½“äºç»•è¿‡äº† DI ç³»ç»Ÿã€‚

```ts
// è·¯ç”±çº§æ³¨å†Œ
@Get(':id')
@UseFilters(CustomExceptionFilter) 
async getUser(@Param('id') id: string) {
    // å½“è¯¥è·¯ç”±æŠ›å‡ºHttpExceptionæ—¶è§¦å‘CustomExceptionFilter
}

// æ§åˆ¶å™¨çº§åˆ«æ³¨å†Œ
@UseFilters(new CustomExceptionFilter())
@Controller('users')
export class UsersController {}

// å…¨å±€æ³¨å†Œï¼ˆmain.tsï¼‰
app.useGlobalFilters(new CustomExceptionFilter());
```

NestJS æ”¯æŒå¤šç§ç±»å‹çš„åº”ç”¨ä¸Šä¸‹æ–‡ï¼ˆæ‰§è¡Œç¯å¢ƒï¼‰ï¼š

| åº”ç”¨ç±»å‹      | ä¸¾ä¾‹                           |
| ------------- | ------------------------------ |
| **HTTP**      | REST æ¥å£                      |
| **WebSocket** | å®æ—¶èŠå¤©ã€é€šçŸ¥ç­‰               |
| **GraphQL**   | ä½¿ç”¨ GraphQL API çš„åº”ç”¨        |
| **æ··åˆåº”ç”¨**  | åŒæ—¶ç”¨ HTTP + WebSocket çš„åº”ç”¨ |

`app.useGlobalFilters()` **åªä¼šå¯¹ HTTP è¯·æ±‚ç”Ÿæ•ˆ**ï¼Œ**ä¸ä¼šä½œç”¨äº WebSocket ç½‘å…³ã€GraphQLã€æˆ–æ··åˆç±»å‹çš„åº”ç”¨ä¸Šä¸‹æ–‡**ï¼Œä¹Ÿå°±æ˜¯å®ƒ**åªä¼šåº”ç”¨åœ¨ HTTP ä¸Šä¸‹æ–‡ä¸­**ï¼ˆä¹Ÿå°±æ˜¯æ§åˆ¶å™¨ Controller çš„å¼‚å¸¸å¤„ç†ä¸­ç”Ÿæ•ˆï¼‰ã€‚

å¦‚æœä½ è¿˜æƒ³è®©å®ƒå¯¹ WebSocket ç”Ÿæ•ˆï¼Œä½ å¿…é¡»åœ¨**WebSocket ç½‘å…³ç±»ä¸­å•ç‹¬è®¾ç½®è¿‡æ»¤å™¨**ã€‚

```ts
@WebSocketGateway()
@UseFilters(new YourExceptionFilter()) // ğŸ‘ˆ å¿…é¡»åœ¨è¿™é‡Œç”¨
export class YourGateway {
  // ...
}
```

**å…¨å±€ä½œç”¨åŸŸçš„å¼‚å¸¸è¿‡æ»¤å™¨**ä¼šå½±å“æ•´ä¸ªåº”ç”¨ï¼Œå®ƒä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰æ§åˆ¶å™¨å’Œè·¯ç”±é‡Œçš„å¼‚å¸¸ï¼Œä¸ç”¨ä½ æ¯ä¸ªåœ°æ–¹éƒ½åŠ  `@UseFilters()`ã€‚

æœ‰æ—¶å€™ä½ æ³¨å†Œçš„å…¨å±€è¿‡æ»¤å™¨ä¸èƒ½ç”¨ä¾èµ–æ³¨å…¥ï¼å½“ä½ è¿™æ ·å†™æ—¶ â†“

```ts
const app = await NestFactory.create(AppModule);
app.useGlobalFilters(new HttpExceptionFilter());
```

è¿™æ®µä»£ç è™½ç„¶è®¾ç½®äº†å…¨å±€è¿‡æ»¤å™¨ï¼Œä½†ä½ æ˜¯ç”¨ `new` æ‰‹åŠ¨åˆ›å»ºçš„ `HttpExceptionFilter` å®ä¾‹ï¼ŒNest **æ— æ³•ç»™å®ƒè‡ªåŠ¨æ³¨å…¥ä¾èµ–**ï¼ˆæ¯”å¦‚ Loggerã€æœåŠ¡ã€é…ç½®ç­‰ï¼‰ã€‚å› ä¸ºå®ƒæ˜¯åœ¨æ¨¡å—ç³»ç»Ÿä¹‹å¤–åˆ›å»ºçš„ã€‚

è§£å†³æ–¹æ¡ˆï¼šé€šè¿‡ `APP_FILTER` ä»¤ç‰Œæ³¨å†Œè¿‡æ»¤å™¨

```ts
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { HttpExceptionFilter } from './filters/http-exception.filter';

@Module({
  providers: [
    {
      provide: APP_FILTER,
      useClass: HttpExceptionFilter,
    },
  ],
})
export class AppModule {}
```

æ„æ€æ˜¯ï¼šè®© Nest æ¥è´Ÿè´£åˆ›å»ºè¿™ä¸ªè¿‡æ»¤å™¨å®ä¾‹ï¼Œå¹¶è‡ªåŠ¨æ³¨å…¥å®ƒä¾èµ–çš„æœåŠ¡ã€‚è¿™ä¸ªæ–¹å¼æ›´â€œä¼˜é›…â€ã€æ›´å®˜æ–¹æ¨èã€‚

æ³¨å†Œä½ç½®çš„å»ºè®®ï¼šä½ å¯ä»¥åœ¨**ä»»ä½•æ¨¡å—ä¸­æ³¨å†Œè¿™ä¸ª APP_FILTER**ï¼Œå®ƒéƒ½ä¼šå˜æˆ**å…¨å±€ç”Ÿæ•ˆ**çš„ã€‚ ä½†**æ›´æ¨èåœ¨å®šä¹‰è¯¥è¿‡æ»¤å™¨çš„æ¨¡å—é‡Œæ³¨å†Œ**ï¼Œè¿™æ ·ç»“æ„æ›´æ¸…æ™°ï¼Œä¹Ÿç¬¦åˆæ¨¡å—èŒè´£åˆ’åˆ†ã€‚

æ€»ç»“ï¼šæƒ³è®©å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ä¹Ÿèƒ½ç”¨ä¾èµ–æ³¨å…¥ï¼Œå°±ä¸è¦ç”¨ `new`ï¼Œè€Œæ˜¯ç”¨ `APP_FILTER + useClass` çš„æ–¹å¼ï¼Œåœ¨æ¨¡å—çš„ `providers` ä¸­æ³¨å†Œã€‚

> **è‡ªåŠ¨ä¾èµ–æ³¨å…¥** åœ¨ **å¼‚å¸¸è¿‡æ»¤å™¨ï¼ˆExceptionFilterï¼‰** ä¸­çš„å®é™…åº”ç”¨ï¼š
>
> ä½ æƒ³åœ¨å‡ºç°å¼‚å¸¸æ—¶ï¼ŒæŠŠé”™è¯¯å†™åˆ°ä¸€ä¸ªæ—¥å¿—æœåŠ¡é‡Œï¼Œè€Œè¿™ä¸ªæœåŠ¡æ˜¯ä½ è‡ªå·±å°è£…çš„ï¼Œæ¯”å¦‚ `LoggerService`ã€‚
>
> æ­¥éª¤ 1ï¼šåˆ›å»ºä¸€ä¸ª LoggerService
>
> ```ts
> // logger.service.ts
> import { Injectable } from '@nestjs/common';
> 
> @Injectable()
> export class LoggerService {
>   logError(message: string) {
>     // è¿™é‡Œç®€åŒ–ä¸ºæ§åˆ¶å°æ‰“å°ï¼Œå®é™…å¯ä»¥å†™å…¥æ–‡ä»¶/æ•°æ®åº“/ç¬¬ä¸‰æ–¹æ—¥å¿—å¹³å°
>     console.error('[LoggerService]', message);
>   }
> }
> ```
>
> æ­¥éª¤ 2ï¼šåˆ›å»ºä¸€ä¸ªå…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ï¼Œæ³¨å…¥ LoggerService
>
> ```ts
> // filters/http-exception.filter.ts
> import {
>   ExceptionFilter,
>   Catch,
>   ArgumentsHost,
>   HttpException,
>   HttpStatus,
> } from '@nestjs/common';
> import { Request, Response } from 'express';
> import { LoggerService } from '../logger.service';
> 
> @Catch()
> export class HttpExceptionFilter implements ExceptionFilter {
>   constructor(private readonly logger: LoggerService) {} // ğŸ‘ˆ è‡ªåŠ¨æ³¨å…¥
> 
>   catch(exception: unknown, host: ArgumentsHost) {
>     const ctx = host.switchToHttp();
>     const response = ctx.getResponse<Response>();
>     const request = ctx.getRequest<Request>();
> 
>     const status =
>       exception instanceof HttpException
>         ? exception.getStatus()
>         : HttpStatus.INTERNAL_SERVER_ERROR;
> 
>     const message =
>       exception instanceof HttpException
>         ? exception.message
>         : 'Internal server error';
> 
>     // âœ… ä½¿ç”¨è‡ªåŠ¨æ³¨å…¥çš„æœåŠ¡æ¥è®°å½•é”™è¯¯
>     this.logger.logError(`[${request.method}] ${request.url} -> ${message}`);
> 
>     response.status(status).json({
>       statusCode: status,
>       message,
>       path: request.url,
>       timestamp: new Date().toISOString(),
>     });
>   }
> }
> ```
>
> æ­¥éª¤ 3ï¼šåœ¨æ¨¡å—ä¸­æ³¨å†Œä¸ºå…¨å±€è¿‡æ»¤å™¨ï¼ˆå¯ç”¨è‡ªåŠ¨æ³¨å…¥ï¼‰
>
> ```ts
> // app.module.ts
> import { Module } from '@nestjs/common';
> import { APP_FILTER } from '@nestjs/core';
> import { LoggerService } from './logger.service';
> import { HttpExceptionFilter } from './filters/http-exception.filter';
> 
> @Module({
>   providers: [
>     LoggerService,
>     {
>       provide: APP_FILTER,
>       useClass: HttpExceptionFilter, // ğŸ‘ˆ ä¸æ˜¯ç”¨ newï¼Œè€Œæ˜¯äº¤ç»™ Nest ç”Ÿæˆ
>     },
>   ],
> })
> export class AppModule {}
> ```
>
> ä»€ä¹ˆæ˜¯â€œè‡ªåŠ¨ä¾èµ–æ³¨å…¥â€ï¼Ÿ
>
> ä½ åªéœ€è¦åœ¨æ„é€ å‡½æ•°ä¸­å£°æ˜ `constructor(private logger: LoggerService)`ï¼ŒNest å°±ä¼š**è‡ªåŠ¨å¸®ä½ åˆ›å»ºå®ä¾‹å¹¶æ³¨å…¥ä¾èµ–**ã€‚
>
> ä½ ä¸éœ€è¦ `new LoggerService()`ï¼ŒNest çš„ IoC å®¹å™¨ä¼šè¯†åˆ«ä¾èµ–å¹¶è‡ªåŠ¨æä¾›ã€‚
>
> å¦‚æœä½ åœ¨ `main.ts` ç”¨ `new HttpExceptionFilter()` çš„æ–¹å¼ï¼Œé‚£ Nest å°±**æ— æ³•æ³¨å…¥ LoggerService**ï¼Œä½ å¿…é¡»è‡ªå·±ä¼ è¿›å»ï¼Œé‚£å°±éº»çƒ¦å¤šäº†ã€‚

æ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä½¿ç”¨æ­¤æŠ€æœ¯æ·»åŠ ä»»æ„æ•°é‡çš„è¿‡æ»¤å™¨ï¼Œåªéœ€å°†æ¯ä¸ªè¿‡æ»¤å™¨æ·»åŠ åˆ° providers æ•°ç»„ä¸­å³å¯ã€‚

**æ•è·æ‰€æœ‰å¼‚å¸¸**

ä¸ºäº†æ•è·**æ¯ä¸€ä¸ª**æœªå¤„ç†çš„å¼‚å¸¸ï¼ˆæ— è®ºå¼‚å¸¸ç±»å‹å¦‚ä½•ï¼‰ï¼Œåªéœ€è®© `@Catch()` è£…é¥°å™¨çš„å‚æ•°åˆ—è¡¨ä¸ºç©ºå³å¯ï¼Œä¾‹å¦‚ `@Catch()`ã€‚

**é€šç”¨å¹³å°ï¼ˆExpress/Fastifyï¼‰å†™æ³•**ï¼š

```ts
import {
  ExceptionFilter,
  Catch,
  ArgumentsHost,
  HttpException,
  HttpStatus,
} from '@nestjs/common';
import { HttpAdapterHost } from '@nestjs/core';

@Catch()
export class CatchEverythingFilter implements ExceptionFilter {
  constructor(private readonly httpAdapterHost: HttpAdapterHost) {}

  catch(exception: unknown, host: ArgumentsHost): void {
    // æœ‰äº›æ—¶å€™ HttpAdapter å¯èƒ½åœ¨æ„é€ å‡½æ•°ä¸­è¿˜ä¸å¯ç”¨ï¼Œä¸ºäº†ç¨³å¦¥å¯ä»¥åœ¨è¿™é‡Œå–
    const { httpAdapter } = this.httpAdapterHost;

    const ctx = host.switchToHttp();

    const httpStatus =
      exception instanceof HttpException
        ? exception.getStatus()
        : HttpStatus.INTERNAL_SERVER_ERROR;

    const responseBody = {
      statusCode: httpStatus,
      timestamp: new Date().toISOString(),
      path: httpAdapter.getRequestUrl(ctx.getRequest()),
    };

    httpAdapter.reply(ctx.getResponse(), responseBody, httpStatus);
  }
}
```

- `HttpAdapterHost` æ˜¯ Nest æŠ½è±¡å‡ºæ¥çš„ HTTP å¹³å°é€‚é…å™¨ï¼ˆæ¯”å¦‚åº•å±‚ç”¨çš„æ˜¯ Expressã€Fastify è¿˜æ˜¯å…¶ä»–éƒ½ä¸å½±å“ï¼‰ã€‚
- `httpAdapter.getRequestUrl()` è·å–è¯·æ±‚è·¯å¾„ã€‚
- `httpAdapter.reply()` æ˜¯å¹³å°æ— å…³çš„å“åº”æ–¹æ³•ï¼Œèƒ½è·¨ Express/Fastify ä½¿ç”¨ã€‚
- æ‰€ä»¥è¿™æ®µä»£ç æ˜¯**è·¨å¹³å°é€šç”¨**çš„å¼‚å¸¸å¤„ç†å™¨ã€‚

**æ³¨æ„**ï¼šå½“ä½ åœ¨é¡¹ç›®æ—¢ä½¿ç”¨ç‰¹å®šå¼‚å¸¸è¿‡æ»¤å™¨ï¼ˆæ¯”å¦‚åªå¤„ç† BadRequestï¼‰åˆä½¿ç”¨æ•è·å…¨éƒ¨çš„è¿‡æ»¤å™¨æ—¶ï¼Œå¿…é¡»å…ˆå£°æ˜æ•è·å…¨éƒ¨çš„è¿‡æ»¤å™¨ã€‚å¦åˆ™ç‰¹å®šç±»å‹çš„å¼‚å¸¸å°±è¢«å®ƒæ‹¦æˆªèµ°äº†ï¼Œå¯¼è‡´ä½ è‡ªå®šä¹‰çš„ç‰¹å®šé€»è¾‘æ— æ•ˆã€‚

**ä¹‹å‰ä¾‹å­çš„å†™æ³•æ˜¯ç‰¹å®šäº Express çš„ï¼Œè€Œç°åœ¨è¿™ä¸ªä¾‹å­æ˜¯â€œå¹³å°æ— å…³â€çš„é€šç”¨å†™æ³•**ã€‚

 åŒºåˆ«æ€»ç»“ï¼š

| æ–¹é¢     | Express ä¸“ç”¨               | å¹³å°æ— å…³ï¼ˆæ¨èï¼‰         |
| -------- | -------------------------- | ------------------------ |
| ä½¿ç”¨å¯¹è±¡ | `Request` / `Response`     | `HttpAdapterHost`        |
| å“åº”æ–¹å¼ | `response.status().json()` | `httpAdapter.reply()`    |
| å…¼å®¹æ€§   | åªèƒ½ç”¨äº Express é¡¹ç›®      | æ”¯æŒ Expressã€Fastify ç­‰ |
| çµæ´»æ€§   | è¾ƒä½ï¼Œä¾èµ–å…·ä½“å¹³å° API     | é«˜ï¼Œå¯åˆ‡æ¢åº•å±‚æ¡†æ¶       |
| æ˜¯å¦æ¨è | å°é¡¹ç›®å¯ä»¥ç”¨               | **ä¸­å¤§å‹é¡¹ç›®æ›´æ¨è**     |

Express ä¸“ç”¨å†™æ³•ï¼ˆä¹‹å‰çš„ï¼‰ï¼š

```ts
const response = ctx.getResponse<Response>();
response.status(status).json({ ... });
```

åªèƒ½ç”¨åœ¨ `Express` é¡¹ç›®ä¸­ï¼Œæ¢æˆ `Fastify` é¡¹ç›®å°±æŠ¥é”™ã€‚

å¹³å°æ— å…³å†™æ³•ï¼š

```ts
const { httpAdapter } = this.httpAdapterHost;
httpAdapter.reply(ctx.getResponse(), responseBody, httpStatus);
```

æ— è®ºä½  Nest é¡¹ç›®çš„åº•å±‚æ˜¯ Expressã€Fastifyï¼Œç”šè‡³æœªæ¥åˆ«çš„ HTTP å¼•æ“ï¼Œå®ƒéƒ½èƒ½å·¥ä½œæ­£å¸¸ï¼Œ**çœŸæ­£åšåˆ°æ¡†æ¶è§£è€¦ã€çµæ´»åˆ‡æ¢**ã€‚

**ç»§æ‰¿**

é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨ä¼šç¼–å†™å®Œå…¨è‡ªå®šä¹‰çš„å¼‚å¸¸è¿‡æ»¤å™¨æ¥æ»¡è¶³åº”ç”¨éœ€æ±‚ã€‚ä½†åœ¨æŸäº›åœºæ™¯ï¼Œæ‚¨å¯èƒ½æƒ³åŸºäº Nest å†…ç½®çš„å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨æ¥åšä¸€äº›å®šåˆ¶ï¼Œæ¯”å¦‚è¦†ç›–æŸäº›é»˜è®¤è¡Œä¸ºã€‚

å®ç°æ–¹å¼æ˜¯ç»§æ‰¿ Nest æ ¸å¿ƒæä¾›çš„ `BaseExceptionFilter` ç±»ï¼Œå¹¶åœ¨è‡ªå·±çš„è¿‡æ»¤å™¨ä¸­è°ƒç”¨çˆ¶ç±»çš„ `catch()` æ–¹æ³•ï¼Œå°†å¼‚å¸¸å¤„ç†æµç¨‹å§”æ‰˜ç»™åŸºç¡€å®ç°ï¼š

```ts
import { Catch, ArgumentsHost } from '@nestjs/common';
import { BaseExceptionFilter } from '@nestjs/core';

@Catch()
export class AllExceptionsFilter extends BaseExceptionFilter {
  catch(exception: unknown, host: ArgumentsHost) {
    super.catch(exception, host);
  }
}
```

**æ³¨æ„**ï¼šç»§æ‰¿è‡ª `BaseExceptionFilter` çš„æ–¹æ³•çº§æˆ–æ§åˆ¶å™¨çº§è¿‡æ»¤å™¨ï¼Œ**ä¸è¦ç”¨ `new` æ‰‹åŠ¨å®ä¾‹åŒ–**ï¼Œåº”ç”± Nest æ¡†æ¶è‡ªåŠ¨ç®¡ç†å®ä¾‹åŒ–ï¼Œä»¥ä¿è¯ä¾èµ–æ³¨å…¥å’Œç”Ÿå‘½å‘¨æœŸæ­£ç¡®ã€‚

å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨å¯ä»¥ç»§æ‰¿è¿™ä¸ªåŸºç¡€è¿‡æ»¤å™¨ï¼Œæœ‰ä¸¤ç§å¸¸è§çš„åº”ç”¨æ–¹å¼ï¼š

ç›´æ¥å®ä¾‹åŒ–å¹¶ä¼ å…¥ `HttpAdapter` å¼•ç”¨ï¼š

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  const { httpAdapter } = app.get(HttpAdapterHost);
  app.useGlobalFilters(new AllExceptionsFilter(httpAdapter));

  await app.listen(process.env.PORT ?? 3000);
}
bootstrap();
```

è¿™é‡Œè‡ªå·± new äº†è¿‡æ»¤å™¨å®ä¾‹ï¼Œå¹¶ä¼ å…¥äº†åº•å±‚çš„ `httpAdapter`ï¼Œç”¨äºå®ç°è·¨å¹³å°ï¼ˆExpressã€Fastifyç­‰ï¼‰çš„å“åº”æ“ä½œã€‚

é€šè¿‡ä¾èµ–æ³¨å…¥ä»¤ç‰Œ `APP_FILTER` æ³¨å†Œï¼š

```ts
@Module({
  providers: [
    {
      provide: APP_FILTER,
      useClass: AllExceptionsFilter,
    },
  ],
})
export class AppModule {}
```

è¿™ç§æ–¹å¼è®© Nest è‡ªåŠ¨å®ä¾‹åŒ–å¹¶æ³¨å…¥ä¾èµ–ï¼Œé€‚åˆä¾èµ–æ³¨å…¥ç®¡ç†æ›´å®Œå–„çš„æƒ…å†µã€‚

æ€»ç»“ï¼š

- ç»§æ‰¿ `BaseExceptionFilter` èƒ½ç›´æ¥å¤ç”¨ Nest çš„é»˜è®¤å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œæ–¹ä¾¿å®šåˆ¶ã€‚
- æ–¹æ³•çº§æˆ–æ§åˆ¶å™¨çº§çš„ç»§æ‰¿è¿‡æ»¤å™¨ä¸è¦è‡ªå·± newï¼Œè€Œæ˜¯è®©æ¡†æ¶ç®¡ç†å®ä¾‹ã€‚
- å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨æ—¢å¯ä»¥æ‰‹åŠ¨ new å¹¶ä¼ å…¥é€‚é…å™¨ï¼Œä¹Ÿå¯ä»¥ç”¨ `APP_FILTER` ä»¤ç‰Œè‡ªåŠ¨æ³¨å…¥ã€‚

å¦‚æœä½ çš„å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨éƒ½æ˜¯è‡ªå·±å†™çš„å®Œå…¨å®šåˆ¶é€»è¾‘ï¼Œé‚£ä¹ˆ**ä¼ å…¥å¹¶ç»§æ‰¿ `BaseExceptionFilter` çš„æ„ä¹‰ä¸»è¦åœ¨äºé‡ç”¨ Nest å†…ç½®çš„å¼‚å¸¸å¤„ç†æœºåˆ¶**ï¼Œå…·ä½“ä½“ç°åœ¨ï¼š

1. **å¤ç”¨æ¡†æ¶é»˜è®¤çš„å¼‚å¸¸å¤„ç†è¡Œä¸º**
    Nest å†…ç½®çš„ `BaseExceptionFilter` å·²ç»å®ç°äº†å¯¹ `HttpException` ç­‰å¸¸è§å¼‚å¸¸çš„æ ‡å‡†å¤„ç†ï¼ˆæ¯”å¦‚è‡ªåŠ¨è®¾ç½®çŠ¶æ€ç ã€æ ¼å¼åŒ–å“åº”ç­‰ï¼‰ï¼Œå¹¶ä¸”æ”¯æŒè·¨å¹³å°é€‚é…ï¼ˆExpressã€Fastifyç­‰ï¼‰ã€‚ç»§æ‰¿å®ƒå¯ä»¥é¿å…ä½ ä»é›¶å¼€å§‹é‡å†™è¿™å¥—é€»è¾‘ã€‚
2. **ä¿æŒè·¨å¹³å°å…¼å®¹æ€§**
    `BaseExceptionFilter` ä½¿ç”¨äº† `HttpAdapter` æ¥å‘é€å“åº”ï¼Œè¿™æ ·ä½ çš„è¿‡æ»¤å™¨åœ¨ä¸åŒåº•å±‚ HTTP æœåŠ¡å™¨ä¹‹é—´æ˜¯æ— æ„Ÿçš„ã€‚å¦‚æœä½ ç›´æ¥å†™æ­» Express çš„ `res` å¯¹è±¡ç­‰ï¼Œç§»æ¤åˆ° Fastify å¯èƒ½å°±éœ€è¦é‡å†™ã€‚
3. **é™ä½ç»´æŠ¤æˆæœ¬å’Œå‡å°‘æ½œåœ¨é”™è¯¯**
    ä½¿ç”¨æ¡†æ¶å·²æœ‰çš„åŸºç¡€å®ç°ï¼Œèƒ½å‡å°‘å› ä¸ºè‡ªå®šä¹‰é€»è¾‘ä¸å®Œå–„å¯¼è‡´çš„å¼‚å¸¸å“åº”é”™è¯¯ã€‚ä¹Ÿæ–¹ä¾¿æ¡†æ¶æœªæ¥å‡çº§æ—¶å‡å°‘å…¼å®¹é—®é¢˜ã€‚

å¦‚æœä½ çš„è‡ªå®šä¹‰è¿‡æ»¤å™¨å·²ç»å®Œå…¨è¦†ç›–å¹¶ä¸”ä¿è¯äº†æ‰€æœ‰å¼‚å¸¸å¤„ç†é€»è¾‘ï¼ˆçŠ¶æ€ç ã€æ ¼å¼ã€æ—¥å¿—ã€è·¨å¹³å°ç­‰ï¼‰éƒ½æ­£ç¡®æ— è¯¯ï¼Œä¸”ä¸ä¾èµ– `BaseExceptionFilter` çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆç»§æ‰¿å®ƒçš„å¿…è¦æ€§å°±ä¸å¤§äº†ã€‚

æ€»ç»“ï¼š

- ç»§æ‰¿ `BaseExceptionFilter` æ˜¯ä¸ºäº†å¤ç”¨ Nest çš„æˆç†Ÿå¼‚å¸¸å¤„ç†æœºåˆ¶å’Œè·¨å¹³å°æ”¯æŒã€‚
- å¦‚æœä½ çš„å®ç°å®Œå…¨è‡ªå®šä¹‰ä¸”ä¸ä¾èµ–è¿™äº›ç‰¹æ€§ï¼Œå¯ä»¥ä¸ç”¨ç»§æ‰¿å®ƒï¼Œç›´æ¥å®ç° `ExceptionFilter` æ¥å£å³å¯ã€‚

## å®Œæ•´èµ„æºæ ·æœ¬{#full-resource-sample}

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨å¤šä¸ª **HTTP è£…é¥°å™¨** åˆ›å»ºçš„åŸºæœ¬æ§åˆ¶å™¨ `CatsController`ï¼Œå®ƒæ”¯æŒå¸¸è§çš„ **å¢åˆ æ”¹æŸ¥ï¼ˆCRUDï¼‰æ“ä½œ**ï¼Œå¹¶é€šè¿‡ DTO ç®¡ç†æ•°æ®ç»“æ„ã€‚

```ts
import {
  Controller,
  Get,
  Query,
  Post,
  Body,
  Put,
  Param,
  Delete,
} from '@nestjs/common';

import {
  CreateCatDto,
  UpdateCatDto,
  ListAllEntities,
} from './dto'; // å¼•å…¥æ•°æ®ä¼ è¾“å¯¹è±¡ DTO

@Controller('cats') // è·¯ç”±å‰ç¼€ï¼šæ‰€æœ‰è·¯ç”±ä»¥ /cats å¼€å¤´
export class CatsController {
  @Post() // POST /cats
  create(@Body() createCatDto: CreateCatDto) {
    // ä»è¯·æ±‚ä½“ä¸­æå– JSON æ•°æ®å¹¶æ˜ å°„åˆ° CreateCatDto ç±»å‹
    return 'This action adds a new cat';
  }

  @Get() // GET /cats
  findAll(@Query() query: ListAllEntities) {
    // ä»æŸ¥è¯¢å‚æ•°ä¸­æå–æ•°æ®ï¼Œå¦‚ /cats?limit=10
    return `This action returns all cats (limit: ${query.limit} items)`;
  }

  @Get(':id') // GET /cats/:id
  findOne(@Param('id') id: string) {
    // ä»è·¯ç”±å‚æ•°ä¸­æå– idï¼Œä¾‹å¦‚ /cats/123
    return `This action returns a #${id} cat`;
  }

  @Put(':id') // PUT /cats/:id
  update(@Param('id') id: string, @Body() updateCatDto: UpdateCatDto) {
    // ä»è·¯ç”±å‚æ•°è·å– idï¼ŒåŒæ—¶ä»è¯·æ±‚ä½“ä¸­è·å–æ›´æ–°æ•°æ®
    return `This action updates a #${id} cat`;
  }

  @Delete(':id') // DELETE /cats/:id
  remove(@Param('id') id: string) {
    // åˆ é™¤æŒ‡å®š ID çš„çŒ«å’ªæ•°æ®
    return `This action removes a #${id} cat`;
  }
}
```

```ts
// ç¤ºä¾‹ï¼šCreateCatDto
export class CreateCatDto {
  name: string;
  age: number;
  breed: string;
}
```

DTO é€šå¸¸ä½¿ç”¨ `class-validator` å’Œ `class-transformer` ç»“åˆ `@Body()` ä¸€èµ·å¯¹æ•°æ®è¿›è¡ŒéªŒè¯å’Œè½¬æ¢ã€‚

## å¢åˆ æ”¹æŸ¥ç”Ÿæˆå™¨{#crud-generator}

> `Entity`ï¼ˆå®ä½“ç±»ï¼‰
>
> - ç”¨åœ¨ ORMï¼ˆå¦‚ TypeORMã€Prismaï¼‰ä¸­
> - æ˜¯åç«¯ä»£ç å’Œæ•°æ®åº“â€œè¡¨â€çš„æ˜ å°„
> - é€šå¸¸ç”¨åœ¨ `Repository.save()`ã€`Repository.find()` è¿™æ ·çš„æ•°æ®åº“æ“ä½œä¸­
>
> Entity æ˜¯æ•°æ®åœ¨åç«¯è½åœ°çš„æ¨¡å‹ï¼Œè€Œ DTO æ˜¯æ•°æ®â€œè¿›é—¨â€ä¹‹å‰çš„æ£€æŸ¥å™¨ã€‚

è®¾æƒ³ä¸€ä¸ªçœŸå®åœºæ™¯ï¼šæˆ‘ä»¬éœ€è¦ä¸ºä¸¤ä¸ªå®ä½“â€”â€”æ¯”å¦‚ç”¨æˆ·ï¼ˆUserï¼‰å’Œäº§å“ï¼ˆProductï¼‰â€”â€”å…¬å¼€å„è‡ªçš„ CRUD æ¥å£ã€‚

æŒ‰ç…§ Nest çš„æœ€ä½³å®è·µï¼Œå¯¹äºæ¯ä¸ªå®ä½“ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦æ‰§è¡Œä»¥ä¸‹å¤šä¸ªæ­¥éª¤ï¼š

- ä½¿ç”¨ `nest g mo` å‘½ä»¤ç”Ÿæˆæ¨¡å—ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç»„ç»‡ä»£ç ã€åˆ’åˆ†æ¸…æ™°è¾¹ç•Œï¼Œå¹¶å¯¹ç›¸å…³ç»„ä»¶è¿›è¡Œåˆ†ç»„
- ä½¿ç”¨ `nest g co` ç”Ÿæˆæ§åˆ¶å™¨ï¼Œå®šä¹‰è¯¥èµ„æºçš„ CRUD è·¯ç”±ï¼ˆæˆ–åœ¨ GraphQL ä¸­å®šä¹‰æŸ¥è¯¢/å˜æ›´ï¼‰
- ä½¿ç”¨ `nest g s` åˆ›å»ºæœåŠ¡ï¼Œç”¨äºå®ç°å’Œå°è£…è¯¥å®ä½“çš„ä¸šåŠ¡é€»è¾‘
- ç¼–å†™ä¸€ä¸ªå®ä½“ç±»æˆ–æ¥å£ï¼Œç”¨äºæè¿°èµ„æºçš„æ•°æ®ç»“æ„
- ç¼–å†™ DTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰ç±»ï¼Œç”¨äºå®šä¹‰å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´ä¼ é€’æ•°æ®çš„æ ¼å¼ï¼ˆGraphQL ä¸­åˆ™ä¸ºè¾“å…¥ç±»å‹ï¼‰

è¿™ä¸€æ•´å¥—æµç¨‹è™½ç„¶æ¸…æ™°è§„èŒƒï¼Œä½†æ­¥éª¤ç¹çã€é‡å¤æ€§é«˜ã€‚

ä¸ºäº†ç®€åŒ–è¿™ä¸€è¿‡ç¨‹ï¼ŒNest æä¾›äº†å¼ºå¤§çš„å‘½ä»¤è¡Œå·¥å…·ï¼ˆCLIï¼‰ï¼Œå…¶ä¸­å†…ç½®çš„**ç”Ÿæˆå™¨ï¼ˆschematicsï¼‰**å¯ä»¥ä¸€é”®è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰è¿™äº›æ ·æ¿ä»£ç ï¼Œå¤§å¹…æå‡å¼€å‘æ•ˆç‡ï¼Œæ”¹å–„å¼€å‘ä½“éªŒã€‚

> **æ”¯æŒç”Ÿæˆ HTTP æ§åˆ¶å™¨ã€å¾®æœåŠ¡æ§åˆ¶å™¨ã€GraphQL è§£æå™¨ï¼ˆä»£ç ä¼˜å…ˆå’Œæ¶æ„ä¼˜å…ˆï¼‰å’Œ WebSocket ç½‘å…³**ã€‚

```bash
$ nest g resource [name]

? What transport layer do you use?
â¯ REST API
  GraphQL (code first)
  GraphQL (schema first)
  Microservice (non-HTTP)
  WebSockets
```

`nest g resource` å‘½ä»¤ä¸ä»…ç”Ÿæˆæ‰€æœ‰ NestJS æ„å»ºå—ï¼ˆ**æ¨¡å—ã€æœåŠ¡ã€æ§åˆ¶å™¨**ç±»ï¼‰ï¼Œè¿˜ç”Ÿæˆ**å®ä½“ç±»**ã€**DTO ç±»**ä»¥åŠæµ‹è¯• (`.spec`) æ–‡ä»¶ï¼Œå¹¶ä¸”è‡ªåŠ¨è¿æ¥å®ƒä»¬ã€‚

> ä¸ºäº†é¿å…ç”Ÿæˆæµ‹è¯•æ–‡ä»¶ï¼Œä½ å¯ä»¥ä¼ é€’ `--no-spec` æ ‡å¿—ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š`nest g resource users --no-spec`

## å¯åŠ¨å¹¶è¿è¡Œ{#getting-up-and-running}

å³ä½¿æˆ‘ä»¬å·²ç»å®šä¹‰äº† `CatsController`ï¼ŒNest å¹¶ä¸ä¼šè‡ªåŠ¨è¯†åˆ«æˆ–å®ä¾‹åŒ–å®ƒã€‚
 åœ¨ NestJS ä¸­ï¼Œ**æ§åˆ¶å™¨ï¼ˆControllerï¼‰å¿…é¡»æ˜¾å¼åœ°æ³¨å†Œåˆ°æ¨¡å—ä¸­**ï¼Œå¦åˆ™å®ƒä»¬ä¸ä¼šè¢«æ¡†æ¶è¯†åˆ«æˆ–ä½¿ç”¨ã€‚

**æ¨¡å—æ˜¯ Nest åº”ç”¨çš„åŸºç¡€æ„å»ºå—**

Nest åº”ç”¨ç¨‹åºæ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å—ç»„æˆçš„ã€‚æ¯ä¸ªæ¨¡å—ä½¿ç”¨ `@Module()` è£…é¥°å™¨å®šä¹‰ï¼Œç”¨äºå£°æ˜å½“å‰æ¨¡å—ä¸­åŒ…å«çš„æ§åˆ¶å™¨ã€æœåŠ¡ã€æä¾›è€…ç­‰ç»„ä»¶ã€‚

ç”±äºæˆ‘ä»¬ç›®å‰åªæœ‰ä¸€ä¸ªæ ¹æ¨¡å— `AppModule`ï¼Œå¯ä»¥ç›´æ¥åœ¨å…¶ä¸­æ³¨å†Œæˆ‘ä»¬çš„æ§åˆ¶å™¨ï¼š

```ts
import { Module } from '@nestjs/common';
import { CatsController } from './cats/cats.controller';

@Module({
  controllers: [CatsController], // æ˜¾å¼æ³¨å†Œ CatsController
})
export class AppModule {}
```

- `@Module()`ï¼šè¿™æ˜¯ Nest æä¾›çš„æ¨¡å—è£…é¥°å™¨ï¼Œç”¨äºå£°æ˜æ¨¡å—å…ƒæ•°æ®ã€‚
- `controllers: [CatsController]`ï¼šè¿™è¡¨ç¤ºè¯¥æ¨¡å—ç®¡ç†çš„æ§åˆ¶å™¨åˆ—è¡¨ï¼ŒNest ä¼šè‡ªåŠ¨æ‰«æè¿™äº›æ§åˆ¶å™¨å¹¶ä¸ºå…¶åˆ›å»ºå®ä¾‹ã€‚
- `AppModule` æ˜¯åº”ç”¨çš„æ ¹æ¨¡å—ï¼Œ**æ‰€æœ‰åŠŸèƒ½æ¨¡å—æœ€ç»ˆéƒ½ä¼šè¢«å¼•å…¥è¿™é‡Œæˆ–è¢«è¯¥æ¨¡å—é—´æ¥å¯¼å…¥**ã€‚

## ç‰¹å®šäºåº“çš„æ–¹æ³•{#library-specific-approach}

Nest é»˜è®¤ä½¿ç”¨æŠ½è±¡çš„æ–¹å¼å¤„ç† HTTP å“åº”ï¼ˆå¦‚é€šè¿‡ `@HttpCode()` è®¾ç½®çŠ¶æ€ç ã€è¿”å›å¯¹è±¡å³ä¸ºå“åº”ä½“ç­‰ï¼‰ã€‚ä½†æœ‰æ—¶å€™ï¼Œä½ å¯èƒ½å¸Œæœ›ç›´æ¥ä½¿ç”¨åº•å±‚æ¡†æ¶ï¼ˆå¦‚ Expressï¼‰çš„å“åº”å¯¹è±¡ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ `@Res()` è£…é¥°å™¨æ³¨å…¥å®ƒã€‚

ä½¿ç”¨ Express å“åº”å¯¹è±¡ï¼š

```ts
import { Controller, Get, Post, Res, HttpStatus } from '@nestjs/common';
import { Response } from 'express'; // æ˜¾å¼ä½¿ç”¨ Express å“åº”ç±»å‹

@Controller('cats')
export class CatsController {
  @Post()
  create(@Res() res: Response) {
    // ç›´æ¥ä½¿ç”¨ res å¯¹è±¡è®¾ç½®çŠ¶æ€ç å’Œå‘é€å“åº”
    res.status(HttpStatus.CREATED).send(); // çŠ¶æ€ç  201
  }

  @Get()
  findAll(@Res() res: Response) {
    // è¿”å› JSON å“åº”
    res.status(HttpStatus.OK).json([]); // çŠ¶æ€ç  200ï¼Œç©ºæ•°ç»„
  }
}
```

 ä½¿ç”¨ `@Res()` çš„æ³¨æ„äº‹é¡¹

è™½ç„¶ç›´æ¥ä½¿ç”¨åº•å±‚å“åº”å¯¹è±¡æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ï¼ˆå¦‚è‡ªå®šä¹‰å¤´éƒ¨ã€è®¾ç½® Cookie ç­‰ï¼‰ï¼Œä½†ä¹Ÿå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

| é—®é¢˜                   | è¯´æ˜                                                         |
| ---------------------- | ------------------------------------------------------------ |
| **ä¸å¹³å°è€¦åˆ**         | ä»£ç ä¾èµ–äºå…·ä½“çš„ HTTP å¹³å°ï¼ˆå¦‚ Expressã€Fastifyï¼‰ï¼Œé™ä½äº†ç§»æ¤æ€§ |
| **ç ´åæ¡†æ¶åŠŸèƒ½å…¼å®¹æ€§** | Nest çš„æ‹¦æˆªå™¨ã€è¿‡æ»¤å™¨ã€`@HttpCode()`ã€`@Header()` ç­‰åŠŸèƒ½å°†å¤±æ•ˆ |
| **å½±å“æµ‹è¯•å¯ç”¨æ€§**     | å•å…ƒæµ‹è¯•ä¸­éœ€è¦æ‰‹åŠ¨æ¨¡æ‹Ÿå“åº”å¯¹è±¡ï¼ˆå¦‚ mock `res.status()`ã€`res.send()`ï¼‰ |

æ¨èæ–¹å¼ï¼šå¯ç”¨ passthroughï¼ˆå…¼é¡¾æ¡†æ¶ä¸åº•å±‚èƒ½åŠ›ï¼‰

ä½ å¯ä»¥ä½¿ç”¨ `@Res({ passthrough: true })`ï¼Œè¯¥æ¨¡å¼å…è®¸ä½ å¯¹å“åº”å¯¹è±¡è¿›è¡Œå±€éƒ¨æ§åˆ¶ï¼ˆå¦‚è®¾ç½® Cookieã€æ ‡å¤´ç­‰ï¼‰ï¼ŒåŒæ—¶ä¾ç„¶ä¿ç•™æ ‡å‡†çš„è¿”å›æœºåˆ¶ã€‚

```ts
@Get()
findAll(@Res({ passthrough: true }) res: Response) {
  res.status(HttpStatus.OK); // è®¾ç½®å“åº”çŠ¶æ€ç ï¼Œä½†ä¸ç«‹å³ç»“æŸå“åº”
  return []; // Nest ç»§ç»­å¤„ç†è¿”å›å€¼ï¼Œå¹¶åºåˆ—åŒ–ä¸ºå“åº”ä½“
}
```

 ä¼˜åŠ¿ï¼š

- ä¿ç•™æ¡†æ¶çš„è‡ªåŠ¨å“åº”å¤„ç†ï¼ˆæ”¯æŒæ‹¦æˆªå™¨ã€å¼‚å¸¸è¿‡æ»¤å™¨ç­‰ï¼‰
- å¯çµæ´»æ“ä½œåŸå§‹å“åº”å¯¹è±¡ï¼ˆå¦‚è®¾ç½® Cookieã€æ ‡å¤´ï¼‰
- ä¿æŒå¹³å°åˆ‡æ¢çš„çµæ´»æ€§ï¼ˆExpress â†” Fastifyï¼‰
